<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Создать задачу — СкладСборка</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      margin:0; background:#0b0f14; color:#fff;
      display:flex; flex-direction:column; align-items:center;
      min-height:100vh; padding:30px;
    }
    h1 {margin-bottom:10px;}
    .container {width:100%; max-width:1100px;}
    textarea,input,button,select {
      font-family:inherit; font-size:15px;
    }
    input,textarea {
      width:100%; box-sizing:border-box; padding:10px;
      border-radius:8px; border:1px solid #444; background:#111; color:#fff;
    }
    button {
      background:#4b9fff; color:#fff; border:0; border-radius:8px;
      padding:10px 20px; cursor:pointer; font-weight:600;
    }
    button:disabled {opacity:.5; cursor:default;}

    table {width:100%; border-collapse:collapse; margin-top:20px;}
    th,td {border:1px solid #333; padding:6px 8px; text-align:left;}
    th {background:#1b1f28;}
    td.lowconf {color:#ff8080;}

    /* === uploader === */
    .uploader {border:2px dashed #4b9fff; border-radius:14px; padding:18px; background:#0b0f14; position:relative; margin:20px 0;}
    .uploader * {user-select:none}
    .uploader.dragover {border-color:#00d084; background:#0b0f14cc}
    .uploader .hint {opacity:.8; font-size:14px; margin-top:8px}
    .uploader .row {display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .uploader button {cursor:pointer; padding:10px 14px; border-radius:10px; border:0; background:#4b9fff; color:#fff; font-weight:600}
    .uploader, .uploader * {pointer-events:auto}
  </style>

  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.js"></script>
  <!-- Tesseract -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.5/dist/tesseract.min.js"></script>
  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAH58ZpWAp64mhM589KD6jXHcOlPqU0aYU",
      authDomain: "skladsborka.firebaseapp.com",
      projectId: "skladsborka",
      storageBucket: "skladsborka.appspot.com",
      appId: "1:516526717198:web:REPLACE_ME_AFTER_WEB_APP_CREATED",
      messagingSenderId: "516526717198"
    };
    const app = initializeApp(firebaseConfig);
    window.db = getFirestore(app);
  </script>
</head>

<body>
<div class="container">
  <h1>Создать задачу</h1>

  <label>Название:</label>
  <input id="title" placeholder="например: Расходная накладная №..." />

  <label>Комментарий:</label>
  <textarea id="comment" rows="3" placeholder="Дополнительная информация..."></textarea>

  <!-- uploader -->
  <div id="uploadBox" class="uploader">
    <div class="row">
      <button id="btnPickFiles" type="button">Выбрать файл(ы)</button>
      <span class="hint">или перетащи PDF/изображения сюда</span>
    </div>
    <input id="fileInput" type="file" multiple accept="application/pdf,image/*"
           style="position:absolute; inset:auto; width:0; height:0; opacity:0;">
  </div>

  <div id="fileList"></div>
  <table id="tbl"><thead><tr>
    <th>Артикул</th><th>Название</th><th>Упак</th><th>Шт</th>
  </tr></thead><tbody></tbody></table>

  <button id="btnSend" disabled>Создать задачу</button>
</div>

<script>
const CLOUDINARY_UPLOAD_URL = "https://api.cloudinary.com/v1_1/YOUR_CLOUD_NAME/upload";
const CLOUDINARY_UPLOAD_PRESET = "YOUR_UPLOAD_PRESET";

// ===== парсер (новый) =====
const UNIT_CANON = {
  "шт":{g:"u",l:"шт"},"штук":{g:"u",l:"шт"},"штука":{g:"u",l:"шт"},
  "упак":{g:"p",l:"упак"},"упаковка":{g:"p",l:"упак"},"упаковок":{g:"p",l:"упак"},"упаковки":{g:"p",l:"упак"},
  "кор":{g:"p",l:"упак"},"короб":{g:"p",l:"упак"},"коробка":{g:"p",l:"упак"},
  "рул":{g:"p",l:"рул"},"рулон":{g:"p",l:"рул"},
  "лист":{g:"u",l:"лист"},"листа":{g:"u",l:"лист"},"листы":{g:"u",l:"лист"},
  "м":{g:"u",l:"м"},"м.п.":{g:"u",l:"м.п."},"мп":{g:"u",l:"м.п."},
  "м2":{g:"u",l:"м²"},"м²":{g:"u",l:"м²"},"кг":{g:"u",l:"кг"},
  "пара":{g:"u",l:"пара"},"пары":{g:"u",l:"пара"},"компл":{g:"u",l:"компл"},"компл.":{g:"u",l:"компл"}
};
function looksLikeHeader(s){return /итог|всего|накладн|склад|поставщик|документ/i.test(s)}
function normNum(t){return parseFloat(t.replace(/[^\d.,]/g,'').replace(',','.').replace(/\s+/g,''))||0;}
const QTY_RX=/(\d[\d\s.,]*)\s*(шт|штук|штука|упак(?:овка|овок|овки)?|кор|коробка?|рул|рулон|лист(?:[а-я]*)?|м2|м²|м\.п\.|мп|м|кг|пара|пары|компл\.?)/gi;
function parseLines(lines){
  const out=[];
  for(let raw of lines){
    raw=raw.trim(); if(!raw||looksLikeHeader(raw))continue;
    let m,arr=[]; while((m=QTY_RX.exec(raw))!==null)arr.push({n:normNum(m[1]),u:m[2].toLowerCase(),i:m.index});
    if(!arr.length)continue;
    let tcut=arr[0].i>0?raw.slice(0,arr[0].i).trim():raw;
    let aMatch=tcut.match(/^([A-Za-zА-Яа-я0-9\-_.]{3,})\b[)\s-]?(.*)$/);
    let art=aMatch?(aMatch[1]||""):"";
    let ttl=aMatch?(aMatch[2]||tcut):tcut;
    let pk=0,un=0,extra=[];
    for(let q of arr){
      let c=UNIT_CANON[q.u]||{}; let n=q.n;
      if(c.g==="p")pk+=n; else un+=n;
      if(!["шт","упак"].includes(c.l))extra.push(`${n} ${c.l||q.u}`);
    }
    if(extra.length)ttl+=` [${extra.join(", ")}]`;
    out.push({article:art,title:ttl,qtyPacks:pk||"",qtyUnits:un||""});
  }
  return out;
}
function parsePdfText(text){return parseLines(text.split(/\n+/g));}

// ===== uploader =====
(function(){
  const zone=document.getElementById('uploadBox');
  const inp=document.getElementById('fileInput');
  const btn=document.getElementById('btnPickFiles');
  btn.onclick=()=>inp.click();
  inp.onchange=e=>{if(e.target.files.length)handleFiles(e.target.files); inp.value='';};
  ['dragenter','dragover','dragleave','drop'].forEach(ev=>{
    document.addEventListener(ev,e=>{
      if(e.target===zone||zone.contains(e.target))return;
      e.preventDefault();e.stopPropagation();
    },false);
  });
  let drag=0;
  zone.addEventListener('dragenter',e=>{e.preventDefault();drag++;zone.classList.add('dragover');});
  zone.addEventListener('dragover',e=>e.preventDefault());
  zone.addEventListener('dragleave',e=>{e.preventDefault();if(--drag<=0)zone.classList.remove('dragover');});
  zone.addEventListener('drop',e=>{
    e.preventDefault();drag=0;zone.classList.remove('dragover');
    if(e.dataTransfer.files.length)handleFiles(e.dataTransfer.files);
  });
})();

async function handleFiles(list){
  const arr=[...list]; if(!arr.length)return;
  document.getElementById('btnSend').disabled=true;
  let allItems=[];
  for(const f of arr){
    document.getElementById('fileList').innerHTML+=`<div>${f.name} — загрузка...</div>`;
    // загрузка в Cloudinary
    const fd=new FormData();
    fd.append('upload_preset',CLOUDINARY_UPLOAD_PRESET);
    fd.append('file',f);
    const r=await fetch(CLOUDINARY_UPLOAD_URL,{method:'POST',body:fd});
    const json=await r.json();
    const url=json.secure_url;
    document.getElementById('fileList').innerHTML+=`<div>✅ ${f.name} загружен</div>`;

    let text="";
    if(f.type==="application/pdf"||f.name.toLowerCase().endsWith(".pdf")){
      const buf=await f.arrayBuffer();
      const pdf=await pdfjsLib.getDocument({data:buf}).promise;
      for(let i=1;i<=pdf.numPages;i++){
        const pg=await pdf.getPage(i);
        const ct=await pg.getTextContent();
        text+=ct.items.map(x=>x.str).join(" ")+"\n";
      }
    } else { // OCR
      const {data:{text:txt}}=await Tesseract.recognize(f,"rus+eng");
      text=txt;
    }
    const items=parsePdfText(text);
    allItems.push(...items);
  }
  renderTable(allItems);
  window._items=allItems;
  document.getElementById('btnSend').disabled=false;
}

function renderTable(items){
  const tb=document.querySelector('#tbl tbody'); tb.innerHTML="";
  for(const it of items){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.article}</td><td>${it.title}</td><td>${it.qtyPacks}</td><td>${it.qtyUnits}</td>`;
    tb.appendChild(tr);
  }
}

// ===== Firestore запись =====
document.getElementById('btnSend').onclick=async()=>{
  const title=document.getElementById('title').value.trim();
  if(!title){alert('Введите название');return;}
  const comment=document.getElementById('comment').value.trim();
  const items=window._items||[];
  const filesDiv=document.getElementById('fileList');
  const fileLinks=[...filesDiv.querySelectorAll('div')]
      .filter(d=>d.textContent.includes('✅'))
      .map(d=>d.textContent.replace('✅','').trim().split(' ')[0]);

  const data={
    title, comment,
    createdAt: new Date(),
    status: "new",
    author: "unknown",
    files: fileLinks,
    items
  };
  try{
    const docRef=await addDoc(collection(db,"tasks"),data);
    alert("Задача создана ✅");
    location.reload();
  }catch(e){alert("Ошибка: "+e);}
};
</script>
</body>
</html>

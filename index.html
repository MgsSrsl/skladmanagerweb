<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ ‚Äî –°–∫–ª–∞–¥–°–±–æ—Ä–∫–∞</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --brand-red:#FF3B30; --text:#0d0d0d; --muted:#666; --line:rgba(0,0,0,.08);
      --glass:#fff; --bg:#f5f6f8;
    }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text) }
    .shell{ max-width:1120px; margin:0 auto; padding:20px 14px 120px }
    h1{ margin:6px 0 18px; font-size:28px; font-weight:800 }

    .grid{ display:grid; grid-template-columns:1fr 440px; gap:16px; align-items:start }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr } }

    .card{ background:var(--glass); border:1px solid rgba(0,0,0,.06); border-radius:16px; padding:16px }
    label{ font-weight:600; font-size:14px; display:block; margin:12px 0 6px }
    input[type="text"], textarea, select{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(0,0,0,.12); font:inherit; background:#fff
    }
    textarea{ min-height:96px; resize:vertical }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .muted{ color:var(--muted); font-size:13px }
    .btn{ border:none; background:var(--brand-red); color:#fff; padding:12px 14px; border-radius:12px; font-weight:800; cursor:pointer }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .btn-secondary{ background:#fff; color:var(--text); border:1px solid rgba(0,0,0,.12) }
    .btn-ghost{ background:transparent; color:var(--text); border:1px dashed var(--line) }
    .files{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
    .chip{ display:inline-flex; gap:8px; align-items:center; background:#fff; border:1px solid rgba(0,0,0,.12); padding:8px 10px; border-radius:12px }
    .chip button{ border:none; background:transparent; font-weight:800; cursor:pointer }
    .switch{ display:flex; align-items:center; gap:10px; margin-top:28px }
    .drop{ padding:12px; border:2px dashed rgba(0,0,0,.2); border-radius:12px; background:#fff }
    .drop.drag{ background:#f8fbff; border-color:#3d7bfd }

    .footer{ position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid var(--line); padding:12px }
    .footer .inner{ max-width:1120px; margin:0 auto; display:flex; gap:10px; justify-content:flex-end }

    .updated{ position:fixed; right:14px; bottom:70px; font-size:13px; color:#222; opacity:.8 }

    /* –°–∞–π–¥–±–∞—Ä –∑–∞–¥–∞—á */
    .aside{ position:sticky; top:12px }
    .aside .hdr{ display:flex; align-items:center; justify-content:space-between; margin-bottom:10px }
    .aside .search{ width:100%; margin-bottom:10px; display:flex; gap:8px }
    .aside input[type="search"]{ flex:1; padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; font:inherit }
    .tasklist{
      display:flex; flex-direction:column; gap:10px;
      max-height:82vh; overflow-y:auto; overflow-x:hidden; padding-right:2px;
    }
    .task{ border:1px solid var(--line); background:#fff; border-radius:14px; padding:10px 12px; display:grid; gap:6px }
    .task .t1{ display:flex; align-items:center; justify-content:space-between; gap:8px }
    .task .title{ font-weight:700; font-size:14px; line-height:1.2; word-break:break-word }
    .badges{ display:flex; gap:6px; flex-wrap:wrap; align-items:center }
    .pill{ font-size:11px; font-weight:700; padding:4px 8px; border-radius:999px; border:1px solid var(--line); background:#fafafa }
    .pill.ok{ color:#065f46; background:#ecfdf5; border-color:#a7f3d0 }
    .pill.info{ color:#1e40af; background:#eff6ff; border-color:#bfdbfe }
    .pill.warn{ color:#7c2d12; background:#fffbeb; border-color:#fde68a }
    .pill.assem{ color:#991b1b; background:#fef2f2; border-color:#fecaca }
    .task .meta{ font-size:12px; color:#555; display:flex; gap:10px; flex-wrap:wrap }
    .task .meta span{ display:inline-flex; align-items:center; gap:6px }
    .task .line{ height:1px; background:var(--line); margin:2px 0 }
    .task .assignees{ font-size:12px; color:#444; }
    .task:hover{ box-shadow:0 1px 0 rgba(0,0,0,.02), 0 6px 16px rgba(0,0,0,.06) }
    .row-compact{ display:grid; grid-template-columns:auto auto 1fr auto; gap:8px; align-items:center }
  </style>
</head>
<body>
  <div class="shell">
    <h1>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h1>

    <div class="grid">
      <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî —Ñ–æ—Ä–º–∞ -->
      <div class="left">
        <div class="card">
          <div class="row">
            <div>
              <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</label>
              <input id="title" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–∫–∞–∑ 12345" />
            </div>
            <div class="switch">
              <input id="cbAssembled" type="checkbox" />
              <label for="cbAssembled" style="margin:0">–°–æ–±—Ä–∞–Ω–Ω—ã–π –∑–∞–∫–∞–∑</label>
            </div>
          </div>

          <label for="comment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <textarea id="comment" placeholder="–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –ø—Ä–∏–º–µ—á–∞–Ω–∏—è"></textarea>

          <div class="row">
            <div>
              <label>–§–∞–π–ª—ã (PDF/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)</label>
              <div id="drop" class="drop">
                <input id="fileInput" type="file" multiple accept="image/*,application/pdf,.pdf" />
                <div class="muted">–í—ã–±–µ—Ä–∏—Ç–µ, –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ (Ctrl+V) —Å–∫—Ä–∏–Ω—à–æ—Ç</div>
              </div>
              <div id="files" class="files"></div>
              <div class="muted" id="filesInfo">–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>
            </div>
            <div>
              <label>–ö–ª–∞–¥–æ–≤—â–∏–∫–∏ (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä)</label>
              <div id="users" class="card" style="padding:8px; height:180px; overflow:auto"></div>
              <div class="muted" id="assigneesInfo">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
            </div>
          </div>
          <div class="muted" style="margin-top:10px">–ü–æ–¥—Å–∫–∞–∑–∫–∞: –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–∞—Ç—å <b>Ctrl/Cmd + V</b>, —á—Ç–æ–±—ã –ø—Ä–∏–∫–ª–µ–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞.</div>
        </div>
      </div>

      <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ ‚Äî —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
      <aside class="aside">
        <div class="hdr">
          <div style="font-weight:800">–ó–∞–¥–∞—á–∏</div>
          <div class="row-compact" style="grid-template-columns:auto 1fr auto">
            <select id="statusFilter">
              <option value="">–í—Å–µ</option>
              <option value="assigned">–ù–∞–∑–Ω–∞—á–µ–Ω–æ</option>
              <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
              <option value="done">–ì–æ—Ç–æ–≤–æ</option>
            </select>
            <div></div>
            <button id="btnReload" class="btn btn-secondary" type="button" title="–û–±–Ω–æ–≤–∏—Ç—å">–û–±–Ω–æ–≤–∏—Ç—å</button>
          </div>
        </div>
        <div class="search">
          <input id="q" type="search" placeholder="–ü–æ–∏—Å–∫ –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ/–∫–æ–º–º–µ–Ω—Ç–µ‚Ä¶" />
        </div>
        <div id="tasklist" class="tasklist card" style="padding:10px"></div>
        <div class="muted" style="margin-top:6px">–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50. –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è.</div>
      </aside>
    </div>

    <div class="updated" id="tvHomeLastUpdated">–°–ø–∏—Å–æ–∫ –∞–∫—Ç—É–∞–ª–µ–Ω: ‚Äî</div>
  </div>

  <div class="footer">
    <div class="inner">
      <button id="btnClear" class="btn btn-secondary" type="button">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–∞–π–ª—ã</button>
      <button id="btnSave" class="btn" type="button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
  <dialog id="editDialog">
    <form method="dialog" class="modal">
      <div class="hdr">
        <div style="font-weight:800">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</div>
        <button type="button" id="btnCloseEdit" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="row">
        <div>
          <label for="edTitle">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input id="edTitle" type="text" />
        </div>
      </div>

      <label for="edComment">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="edComment"></textarea>

      <div class="row section">
        <label style="display:flex;align-items:center;gap:8px;margin:0">
          <input id="edAssembled" type="checkbox" /> –°–æ–±—Ä–∞–Ω–Ω—ã–π –∑–∞–∫–∞–∑
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin:0">
          <input id="edPickup" type="checkbox" /> –°–∞–º–æ–≤—ã–≤–æ–∑
        </label>
      </div>

      <div class="section">
        <label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏</label>
        <div id="edUsers" class="card" style="padding:8px; max-height:200px; overflow:auto"></div>
        <div class="muted" id="edAssigneesInfo" style="margin-top:4px"></div>
      </div>

      <div class="section">
        <label>–í–ª–æ–∂–µ–Ω–∏—è</label>
        <div id="edExistingFiles" class="files"></div>
        <div class="sub">–ö—Ä–µ—Å—Ç ‚Äî —É–±—Ä–∞—Ç—å –∏–∑ –∑–∞–¥–∞—á–∏. üëÅ ‚Äî –æ—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ.</div>
        <div class="card" style="margin-top:8px; padding:10px">
          <div id="edDrop" class="drop">
            <input id="edFileInput" type="file" multiple accept="image/*,application/pdf,.pdf" />
            <div class="muted">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª—ã: –≤—ã–±–µ—Ä–∏—Ç–µ, –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ (Ctrl+V)</div>
          </div>
          <div id="edNewFiles" class="files"></div>
          <div class="muted" id="edFilesInfo">–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã</div>
        </div>
      </div>

      <div class="act" style="margin-top:12px">
        <button type="button" id="btnDelete" class="btn btn-secondary" style="border-color:#f00;color:#f00">–£–¥–∞–ª–∏—Ç—å</button>
        <div style="flex:1"></div>
        <button type="button" id="btnSaveEdit" class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </dialog>

  <!-- –î–∏–∞–ª–æ–≥ ¬´–í–ª–æ–∂–µ–Ω–∏—è¬ª -->
  <dialog id="filesDialog">
    <form method="dialog" class="modal">
      <div class="hdr">
        <div style="font-weight:800">–í–ª–æ–∂–µ–Ω–∏—è</div>
        <button type="submit" class="btn-ghost">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div id="filesDialogList" class="files"></div>
      <div class="muted" style="margin-top:6px">–ö–ª–∏–∫–Ω–∏ ¬´–û—Ç–∫—Ä—ã—Ç—å¬ª –Ω–∞–ø—Ä–æ—Ç–∏–≤ –Ω—É–∂–Ω–æ–≥–æ —Ñ–∞–π–ª–∞.</div>
    </form>
  </dialog>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
  // ====== –ö–û–ù–§–ò–ì ======
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyAH58ZpWAp64mhM589KD6jXHcOlPqU0aYU",
    authDomain: "skladsborka-6c2a7.firebaseapp.com",
    projectId: "skladsborka-6c2a7",
    storageBucket: "skladsborka-6c2a7.firebasestorage.app",
    appId: "1:516526717198:android:e470c17aed370572757f5f"
  };
  const CLOUDINARY_CLOUD_NAME    = "dnx1taqp7";
  const CLOUDINARY_UPLOAD_PRESET = "unsigned_tasks";
  const FOLDER_PREFIX            = "tasks";
  const NOTIFY_URL_CREATED       = "https://skladsborka-notify.vercel.app/api/notify-taskCreated";
  const NOTIFY_URL_ASSIGNEES     = "https://skladsborka-notify.vercel.app/api/notify-assigneesChanged";
  // =====================

  firebase.initializeApp(FIREBASE_CONFIG);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  const els = {
    title: document.getElementById('title'),
    comment: document.getElementById('comment'),
    cbAssembled: document.getElementById('cbAssembled'),
    fileInput: document.getElementById('fileInput'),
    files: document.getElementById('files'),
    filesInfo: document.getElementById('filesInfo'),
    users: document.getElementById('users'),
    assigneesInfo: document.getElementById('assigneesInfo'),
    btnSave: document.getElementById('btnSave'),
    btnClear: document.getElementById('btnClear'),
    drop: document.getElementById('drop'),
    tvHomeLastUpdated: document.getElementById('tvHomeLastUpdated'),
    tasklist: document.getElementById('tasklist'),
    btnReload: document.getElementById('btnReload'),
    q: document.getElementById('q'),
    statusFilter: document.getElementById('statusFilter'),
    dlg: document.getElementById('editDialog'),
    btnCloseEdit: document.getElementById('btnCloseEdit'),
    btnSaveEdit: document.getElementById('btnSaveEdit'),
    btnDelete: document.getElementById('btnDelete'),
    edTitle: document.getElementById('edTitle'),
    edComment: document.getElementById('edComment'),
    edAssembled: document.getElementById('edAssembled'),
    edPickup: document.getElementById('edPickup'),
    edUsers: document.getElementById('edUsers'),
    edAssigneesInfo: document.getElementById('edAssigneesInfo'),
    edExistingFiles: document.getElementById('edExistingFiles'),
    edDrop: document.getElementById('edDrop'),
    edFileInput: document.getElementById('edFileInput'),
    edNewFiles: document.getElementById('edNewFiles'),
    edFilesInfo: document.getElementById('edFilesInfo'),
    filesDialog: document.getElementById('filesDialog'),
    filesDialogList: document.getElementById('filesDialogList')
  };

  const selectedFiles = [];
  const selectedWorkerIds = new Set();
  const selectedWorkerNames = new Set();

  let allUsersCache = [];
  let editingTask = null;
  let edSelectedIds = new Set();
  let edSelectedNames = new Set();
  let edExisting = [];
  let edRemovedPids = new Set();
  const edNewSelected = [];

  // ====== OFFLINE RESEND QUEUE (form-urlencoded) ======
  const QUEUE_KEY = 'notify_queue_v1';

  function qSaveItem(item){
    const arr = JSON.parse(localStorage.getItem(QUEUE_KEY)||'[]');
    arr.push(item);
    localStorage.setItem(QUEUE_KEY, JSON.stringify(arr));
  }
  async function qTryResendAll(){
    let arr = JSON.parse(localStorage.getItem(QUEUE_KEY)||'[]');
    if(!arr.length) return;
    const keep = [];
    for(const it of arr){
      try{
        const resp = await fetch(it.url, {
          method:'POST',
          headers:{'Content-Type': it.ct || 'application/x-www-form-urlencoded'},
          body: it.body || ''
        });
        if(!resp.ok) throw new Error(String(resp.status));
      }catch(e){
        keep.push(it);
      }
    }
    localStorage.setItem(QUEUE_KEY, JSON.stringify(keep));
  }
  async function sendFormOrQueue(url, params){
    const ct = 'application/x-www-form-urlencoded';
    const body = new URLSearchParams(params).toString();
    try{
      const resp = await fetch(url, { method:'POST', headers:{'Content-Type': ct}, body });
      if(!resp.ok) throw new Error(String(resp.status));
    }catch(e){
      qSaveItem({ url, ct, body });
    }
  }
  

  // ======= AUTH + —Å—Ç–∞—Ä—Ç =======
 auth.signInAnonymously()
  .then(() => { 
 
    touchLastUpdated();
    loadUsers();
    initTasksFeed();
  })
  .catch(e => alert("Auth error: " + (e?.message||e)));

  // ======= USERS =======
  async function loadUsers(){
    const snap = await db.collection('users').get();
    const frag = document.createDocumentFragment();
    allUsersCache = [];
    if (snap.empty){
      els.users.innerHTML = '<div class="muted">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
    } else {
      snap.forEach(doc=>{
        const data = doc.data()||{};
        const base = data.name || data.displayName || doc.id;
        const role = data.role ? ` (${data.role})` : '';
        const label = `${base}${role}`;
        const id = doc.id;
        allUsersCache.push({id, base, label});
        const row = document.createElement('label');
        row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px 4px';
        row.innerHTML = `<input type="checkbox" data-id="${id}" data-name="${escapeHtml(label)}" /> <span>${escapeHtml(label)}</span>`;
        row.querySelector('input').addEventListener('change', ev=>{
          const chk = ev.target; const uid = chk.getAttribute('data-id'); const nm = chk.getAttribute('data-name');
          if (chk.checked){ selectedWorkerIds.add(uid); selectedWorkerNames.add(nm); }
          else { selectedWorkerIds.delete(uid); selectedWorkerNames.delete(nm); }
          updateAssigneesInfo();
        });
        frag.appendChild(row);
      });
      els.users.innerHTML = ''; els.users.appendChild(frag);
      updateAssigneesInfo();
    }
  }
  function updateAssigneesInfo(){
    els.assigneesInfo.textContent = selectedWorkerNames.size
      ? "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: " + [...selectedWorkerNames].join(", ")
      : "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)";
  }

  // ======= FILES UI / DND / PASTE (—Å–æ–∑–¥–∞–Ω–∏–µ) =======
  els.fileInput.addEventListener('change', e=>{
    [...(e.target.files||[])].forEach(f=>{ if(!selectedFiles.includes(f)) selectedFiles.push(f); });
    renderFiles();
  });
  ['dragenter','dragover'].forEach(ev=> els.drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); els.drop.classList.add('drag'); }));
  ['dragleave','drop'].forEach(ev=> els.drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); els.drop.classList.remove('drag'); }));
  els.drop.addEventListener('drop', e=>{
    const files = [...(e.dataTransfer?.files||[])];
    files.forEach(f=>{ if(!selectedFiles.includes(f)) selectedFiles.push(f); });
    renderFiles();
  });
  els.btnClear.addEventListener('click', ()=>{ selectedFiles.length=0; renderFiles(); els.fileInput.value=''; });

  function renderFiles(){
    els.files.innerHTML='';
    selectedFiles.forEach((f,i)=>{
      const chip=document.createElement('span'); chip.className='chip';
      chip.innerHTML=`<span title="${escapeHtml(f.name)}">${escapeHtml(short(f.name))}</span> <button>&times;</button>`;
      chip.querySelector('button').onclick=()=>{selectedFiles.splice(i,1);renderFiles();};
      els.files.appendChild(chip);
    });
    els.filesInfo.textContent = selectedFiles.length ? `–§–∞–π–ª–æ–≤ –≤—ã–±—Ä–∞–Ω–æ: ${selectedFiles.length}` : '–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã';
  }
  const short=s=>s.length>36?(s.slice(0,16)+'‚Ä¶'+s.slice(-16)):s;
  const escapeHtml=s=>String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));

  document.addEventListener('paste', e=>{
    if (els.dlg.open) return;
    const dt=e.clipboardData; if(!dt)return;
    let added=0;
    for(const item of dt.items||[]){
      if(item.kind==='file'){
        const file=item.getAsFile();
        if(!file) continue;
        if(file.type.startsWith('image/')){
          const name=`screenshot_${Date.now()}.png`;
          const f=new File([file],name,{type:file.type});
          selectedFiles.push(f); added++;
        } else if(file.type==='application/pdf'){
          const name=`pasted_${Date.now()}.pdf`;
          const f=new File([file],name,{type:file.type});
          selectedFiles.push(f); added++;
        }
      }
    }
    if(added){ renderFiles(); infoFlash(els.filesInfo, `–í—Å—Ç–∞–≤–ª–µ–Ω–æ –∏–∑ –±—É—Ñ–µ—Ä–∞: ${added}`); e.preventDefault(); }
  });
  function infoFlash(el, text){
    el.textContent=text; el.style.fontWeight='800';
    setTimeout(()=>{
      el.textContent = (el===els.filesInfo)
        ? (selectedFiles.length ? `–§–∞–π–ª–æ–≤ –≤—ã–±—Ä–∞–Ω–æ: ${selectedFiles.length}` : '–§–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã')
        : (edNewSelected.length ? `–ù–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤: ${edNewSelected.length}` : '–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã');
      el.style.fontWeight='normal';
    }, 1600);
  }

  // ======= SAVE (—Å–æ–∑–¥–∞–Ω–∏–µ) =======
  els.btnSave.addEventListener('click', onSave);
  async function onSave(){
    const title=els.title.value.trim(); const comment=els.comment.value.trim(); const isAssembled=!!els.cbAssembled.checked;
    if(!title){ alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è"); return; }
    freeze(true,"–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶");
    try{
      const audienceIds=[...selectedWorkerIds]; const audienceNames=[...selectedWorkerNames];
      const category=isAssembled?"assembled_order":(audienceIds.length===0?"pickup":"default");
      const status=isAssembled?"assembled":"assigned"; const isPickup=isAssembled?false:(audienceIds.length===0);

      const taskRef=db.collection('tasks').doc();
      await taskRef.set({
        title, comment,
        assignees:audienceIds, assigneeNames:audienceNames,
        isPickup, assembledOrder:isAssembled,
        category, status,
        createdAt:firebase.firestore.FieldValue.serverTimestamp(),
        creatorId:"unknown", creatorName:"unknown",
        files:[]
      });

      if(selectedFiles.length){
        const uploaded=await uploadAllFiles(taskRef.id,selectedFiles);
        if(uploaded.length){ await taskRef.update({files:uploaded}); }
      }

      await notifyTaskCreated(taskRef.id,audienceIds);
      // reset
      selectedFiles.length=0; renderFiles(); els.fileInput.value='';
      els.title.value=''; els.comment.value=''; els.cbAssembled.checked=false;
      [...document.querySelectorAll('#users input[type=checkbox]')].forEach(ch=>ch.checked=false);
      selectedWorkerIds.clear(); selectedWorkerNames.clear(); updateAssigneesInfo();
      alert("–ó–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ");
    }catch(e){ alert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: "+(e?.message||e)); }
    finally{ freeze(false); touchLastUpdated(); }
  }

  async function uploadAllFiles(taskId, files){
    const out=[];
    for(const f of files){
      const endpoint = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;
      const fd = new FormData();
      fd.append('file', f);
      fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
      fd.append('folder', `${FOLDER_PREFIX}/${taskId}`);
      const resp = await fetch(endpoint,{method:'POST',body:fd});
      if(!resp.ok){ const t=await resp.text().catch(()=> ""); throw new Error(`upload failed (${resp.status}) ${t}`); }
      const j = await resp.json();
      out.push({
        url: j.secure_url || j.url || "",
        publicId: j.public_id || "",
        type: (f.type==='application/pdf' || /\.pdf$/i.test(f.name)) ? "pdf" : "image",
        name: f.name || "file"
      });
    }
    return out;
  }

  // –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (form-urlencoded + –æ—Ñ–ª–∞–π–Ω –æ—á–µ—Ä–µ–¥—å)
  function notifyTaskCreated(taskId,audienceIds){
    const assigneeIdsCsv=(audienceIds&&audienceIds.length)?audienceIds.join(","):"";
    return sendFormOrQueue(NOTIFY_URL_CREATED, { taskId, assigneeIds: assigneeIdsCsv });
  }
  function notifyAssigneesChanged(taskId, newIds){
    if(!newIds || !newIds.length) return Promise.resolve();
    return sendFormOrQueue(NOTIFY_URL_ASSIGNEES, { taskId, assigneeIds: newIds.join(",") });
  }

  function freeze(flag,text){ els.btnSave.disabled=!!flag; els.btnSave.textContent=flag?(text||"‚Ä¶"):"–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ"; }
  function touchLastUpdated(){
    const d=new Date(); const pad=n=>String(n).padStart(2,'0');
    const s=`${pad(d.getDate())}.${pad(d.getMonth()+1)} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    els.tvHomeLastUpdated.textContent="–°–ø–∏—Å–æ–∫ –∞–∫—Ç—É–∞–ª–µ–Ω: "+s;
  }

  // ======= TASKS FEED (–ø—Ä–∞–≤—ã–π —Å–∞–π–¥–±–∞—Ä) =======
  let unsubTasks=null, lastTasks=[], filteredTasks=[];
  function initTasksFeed(){
    subscribeTasks();
    els.btnReload.addEventListener('click', ()=>{ qTryResendAll(); subscribeTasks(true); });
    els.q.addEventListener('input', applyFilter);
    els.statusFilter.addEventListener('change', applyFilter);
  }
  function subscribeTasks(){
    if(unsubTasks){ unsubTasks(); unsubTasks=null; }
    const q = db.collection('tasks').orderBy('createdAt','desc').limit(50);
    unsubTasks = q.onSnapshot(snap=>{
      const arr=[];
      snap.forEach(d=>{
        const x=d.data()||{};
        arr.push({
          id:d.id,
          title: x.title || '(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)',
          comment: x.comment || '',
          status: String(x.status||'assigned').toLowerCase(),
          isPickup: !!x.isPickup,
          assembledOrder: !!x.assembledOrder || String(x.status).toLowerCase()==='assembled',
          files: Array.isArray(x.files)? x.files : [],
          assigneeNames: Array.isArray(x.assigneeNames)? x.assigneeNames : [],
          assignees: Array.isArray(x.assignees)? x.assignees : [],
          createdAt: x.createdAt?.toDate ? x.createdAt.toDate() : null
        });
      });
      lastTasks = arr;
      applyFilter();
      touchLastUpdated();
    }, err=> console.error('tasks snapshot error', err));
  }
  function applyFilter(){
    const text = (els.q.value||'').trim().toLowerCase();
    const status = els.statusFilter.value;
    filteredTasks = lastTasks.filter(t=>{
      const matchText = !text || (t.title||'').toLowerCase().includes(text) || (t.comment||'').toLowerCase().includes(text);
      const matchStatus = !status || t.status===status;
      return matchText && matchStatus;
    });
    renderTasks();
  }
  function renderTasks(){
    const list = els.tasklist;
    list.innerHTML='';
    if(!filteredTasks.length){ list.innerHTML='<div class="muted">–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'; return; }
    const frag=document.createDocumentFragment();
    for(const t of filteredTasks){
      const div=document.createElement('div');
      div.className='task';
      const badges = [];
      const st = (t.status||'assigned').toLowerCase();
      if(st==='done') badges.push(`<span class="pill ok">–ì–æ—Ç–æ–≤–æ</span>`);
      else if(st==='in_progress') badges.push(`<span class="pill info">–í —Ä–∞–±–æ—Ç–µ</span>`);
      else badges.push(`<span class="pill">–ù–∞–∑–Ω–∞—á–µ–Ω–æ</span>`);
      if(t.isPickup) badges.push(`<span class="pill warn">–°–∞–º–æ–≤—ã–≤–æ–∑</span>`);
      if(t.assembledOrder) badges.push(`<span class="pill assem">–°–æ–±—Ä–∞–Ω–Ω—ã–π</span>`);
      const created = t.createdAt ? formatTime(t.createdAt) : '‚Äî';
      const filesCount = (t.files||[]).length;
      const ass = t.assigneeNames?.length ? `üë• ${escapeHtml(t.assigneeNames.join(', '))}` : '';
      div.innerHTML = `
        <div class="t1">
          <div class="title">${escapeHtml(t.title)}</div>
          <div class="badges">${badges.join(' ')}</div>
        </div>
        <div class="meta">
          <span>‚è± ${created}</span>
          <span>üìé ${filesCount}</span>
          ${ass?`<span>${ass}</span>`:''}
        </div>
        ${t.comment ? `<div class="line"></div><div class="assignees">${escapeHtml(t.comment)}</div>` : ''}
        <div class="row-compact" style="margin-top:4px">
          <button class="btn btn-secondary" data-act="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          ${filesCount ? `<button class="btn btn-secondary" data-act="open">–û—Ç–∫—Ä—ã—Ç—å</button>` : ``}
          <div></div>
          <button class="btn btn-secondary" data-act="delete" style="border-color:#f00;color:#f00">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      `;
      const btnOpen = div.querySelector('[data-act="open"]');
      if(btnOpen){
        btnOpen.addEventListener('click', ()=>{
          const files = t.files || [];
          if(!files.length){ alert('–ù–µ—Ç –≤–ª–æ–∂–µ–Ω–∏–π'); return; }
          openFilesChooser(t);
        });
      }
      div.querySelector('[data-act="edit"]').addEventListener('click', ()=> openEditModal(t.id));
      div.querySelector('[data-act="delete"]').addEventListener('click', ()=> deleteTask(t.id));
      frag.appendChild(div);
    }
    list.appendChild(frag);
  }
  function formatTime(d){
    const pad=n=>String(n).padStart(2,'0');
    return `${pad(d.getDate())}.${pad(d.getMonth()+1)} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  // ======= EDIT MODAL =======
  async function openEditModal(taskId){
    const doc = await db.collection('tasks').doc(taskId).get();
    if(!doc.exists){ alert('–ó–∞–¥–∞—á–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); return; }
    const x = doc.data()||{};
    editingTask = {
      id: doc.id,
      title: x.title||'',
      comment: x.comment||'',
      status: String(x.status||'assigned'),
      isPickup: !!x.isPickup,
      assembledOrder: !!x.assembledOrder || String(x.status).toLowerCase()==='assembled',
      assignees: Array.isArray(x.assignees)? x.assignees : [],
      assigneeNames: Array.isArray(x.assigneeNames)? x.assigneeNames : [],
      files: Array.isArray(x.files)? x.files : []
    };

    els.edTitle.value = editingTask.title;
    els.edComment.value = editingTask.comment;
    els.edAssembled.checked = !!editingTask.assembledOrder;
    els.edPickup.checked = !!editingTask.isPickup;

    edSelectedIds = new Set(editingTask.assignees);
    edSelectedNames = new Set(editingTask.assigneeNames);
    renderEdUsers();

    edExisting = [...editingTask.files];
    edRemovedPids = new Set();
    edNewSelected.length = 0;
    renderEdExistingFiles();
    renderEdNewFiles();

    els.dlg.showModal();
  }
  function renderEdUsers(){
    const frag = document.createDocumentFragment();
    allUsersCache.forEach(u=>{
      const row = document.createElement('label');
      row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px 4px';
      const checked = edSelectedIds.has(u.id) ? 'checked' : '';
      row.innerHTML = `<input type="checkbox" data-id="${u.id}" data-name="${escapeHtml(u.label)}" ${checked}/> <span>${escapeHtml(u.label)}</span>`;
      row.querySelector('input').addEventListener('change', ev=>{
        const chk = ev.target; const uid = chk.getAttribute('data-id'); const nm = chk.getAttribute('data-name');
        if (chk.checked){ edSelectedIds.add(uid); edSelectedNames.add(nm); }
        else { edSelectedIds.delete(uid); edSelectedNames.delete(nm); }
        updateEdAssigneesInfo();
      });
      frag.appendChild(row);
    });
    els.edUsers.innerHTML=''; els.edUsers.appendChild(frag);
    updateEdAssigneesInfo();
  }
  function updateEdAssigneesInfo(){
    els.edAssigneesInfo.textContent = edSelectedNames.size
      ? "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: " + [...edSelectedNames].join(", ")
      : "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã";
  }

  function renderEdExistingFiles(){
    els.edExistingFiles.innerHTML = '';
    if(!edExisting.length){
      els.edExistingFiles.innerHTML = '<span class="muted">–ù–µ—Ç –≤–ª–æ–∂–µ–Ω–∏–π</span>';
      return;
    }
    edExisting.forEach((f,i)=>{
      const removed = edRemovedPids.has(f.publicId);
      const chip=document.createElement('span'); chip.className='chip';
      chip.style.opacity = removed ? '.4' : '1';
      const name = f.name || f.publicId || `file_${i+1}`;
      chip.innerHTML = `
        <span title="${escapeHtml(name)}">
          ${f.type==='pdf'?'üìÑ':'üñº'} ${escapeHtml(short(name))}
        </span>
        <button title="–û—Ç–∫—Ä—ã—Ç—å" data-act="open">üëÅ</button>
        <button title="${removed?'–í–µ—Ä–Ω—É—Ç—å':'–£–¥–∞–ª–∏—Ç—å'}" data-act="toggle">${removed?'‚Ü©':'√ó'}</button>`;
      chip.querySelector('[data-act="open"]').onclick = ()=> openFile(f.url || f.secure_url);
      chip.querySelector('[data-act="toggle"]').onclick = ()=>{
        if(removed){ edRemovedPids.delete(f.publicId); }
        else { edRemovedPids.add(f.publicId); }
        renderEdExistingFiles();
      };
      els.edExistingFiles.appendChild(chip);
    });
  }

  els.edFileInput.addEventListener('change', e=>{
    [...(e.target.files||[])].forEach(f=>{ if(!edNewSelected.includes(f)) edNewSelected.push(f); });
    renderEdNewFiles();
  });
  ['dragenter','dragover'].forEach(ev=> els.edDrop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); els.edDrop.classList.add('drag'); }));
  ['dragleave','drop'].forEach(ev=> els.edDrop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); els.edDrop.classList.remove('drag'); }));
  els.edDrop.addEventListener('drop', e=>{
    const files = [...(e.dataTransfer?.files||[])];
    files.forEach(f=>{ if(!edNewSelected.includes(f)) edNewSelected.push(f); });
    renderEdNewFiles();
  });
  els.dlg.addEventListener('paste', e=>{
    const dt=e.clipboardData; if(!dt)return;
    let added=0;
    for(const item of dt.items||[]){
      if(item.kind==='file'){
        const file=item.getAsFile(); if(!file) continue;
        let name = file.name || (file.type==='application/pdf' ? `pasted_${Date.now()}.pdf` : `screenshot_${Date.now()}.png`);
        const f=new File([file], name, {type:file.type});
        edNewSelected.push(f); added++;
      }
    }
    if(added){ renderEdNewFiles(); infoFlash(els.edFilesInfo, `–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö: ${added}`); e.preventDefault(); }
  });
  function renderEdNewFiles(){
    els.edNewFiles.innerHTML='';
    edNewSelected.forEach((f,i)=>{
      const chip=document.createElement('span'); chip.className='chip';
      chip.innerHTML=`<span title="${escapeHtml(f.name)}">${f.type==='application/pdf'?'üìÑ':'üñº'} ${escapeHtml(short(f.name))}</span> <button>&times;</button>`;
      chip.querySelector('button').onclick=()=>{edNewSelected.splice(i,1);renderEdNewFiles();};
      els.edNewFiles.appendChild(chip);
    });
    els.edFilesInfo.textContent = edNewSelected.length ? `–ù–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤: ${edNewSelected.length}` : '–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –≤—ã–±—Ä–∞–Ω—ã';
  }

  els.btnCloseEdit.addEventListener('click', ()=> els.dlg.close());

  els.btnSaveEdit.addEventListener('click', async ()=>{
    if(!editingTask) return;
    const newTitle = els.edTitle.value.trim();
    if(!newTitle){ alert('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ'); return; }
    const newComment = els.edComment.value.trim();
    const newAssembled = !!els.edAssembled.checked;
    const newPickup = !!els.edPickup.checked;

    const oldAssignees = new Set(editingTask.assignees||[]);
    const newAssignees = [...edSelectedIds];
    const newAssigneeNames = [...edSelectedNames];
    const onlyNewAssignees = newAssignees.filter(id=> !oldAssignees.has(id));

    try{
      const kept = edExisting.filter(f=> !edRemovedPids.has(f.publicId));
      let uploaded = [];
      if(edNewSelected.length){
        uploaded = await uploadAllFiles(editingTask.id, edNewSelected);
      }
      const filesMerged = kept.concat(uploaded);

      await db.collection('tasks').doc(editingTask.id).update({
        title:newTitle,
        comment:newComment,
        assembledOrder:newAssembled,
        isPickup:newPickup,
        assignees:newAssignees,
        assigneeNames:newAssigneeNames,
        files: filesMerged
      });

      await notifyAssigneesChanged(editingTask.id, onlyNewAssignees);
      els.dlg.close();
    }catch(e){
      alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: '+(e?.message||e));
    }
  });

  async function deleteTask(taskId){
    if(!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É –±–µ–∑–≤–æ–∑–≤—Ä–∞—Ç–Ω–æ?')) return;
    try{
      await db.collection('tasks').doc(taskId).delete();
    }catch(e){
      alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: '+(e?.message||e));
    }
  }
  document.getElementById('btnDelete')?.addEventListener('click', async ()=>{
    if(!editingTask) return;
    await deleteTask(editingTask.id);
    els.dlg.close();
  });

  function openFilesChooser(task){
    els.filesDialogList.innerHTML = '';
    const files = task.files || [];
    files.forEach((f, i)=>{
      const chip = document.createElement('span');
      chip.className = 'chip';
      const name = (f.name || f.publicId || `file_${i+1}`);
      chip.innerHTML = `
        <span title="${escapeHtml(name)}">
          ${f.type==='pdf' ? 'üìÑ' : 'üñº'} ${escapeHtml(short(name))}
        </span>
        <button data-act="open">–û—Ç–∫—Ä—ã—Ç—å</button>
      `;
      chip.querySelector('[data-act="open"]').onclick = ()=>{
        const url = f.url || f.secure_url;
        if(!url){ alert('URL –Ω–µ –Ω–∞–π–¥–µ–Ω'); return; }
        openFile(url);
      };
      els.filesDialogList.appendChild(chip);
    });
    els.filesDialog.showModal();
  }
  function openFile(url){
    if(!url) return;
    window.open(url, '_blank', 'noopener,noreferrer');
  }
  </script>
</body>
</html>

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Создать задачу — СкладСборка (Web)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --brand-red:#FF3B30;
      --glass:#ffffffcc;            /* лёгкое стекло */
      --stroke:rgba(0,0,0,.10);
      --text:rgba(0,0,0,.88);
      --muted:rgba(0,0,0,.65);
      --shadow:0 10px 38px rgba(0,0,0,.10);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 1200px at -10% -10%, rgba(255,59,48,.10), transparent 60%),
        radial-gradient(1200px 1200px at 110% 110%, rgba(0,0,0,.06), transparent 60%),
        #ECEFF3;
    }
    .wrap{max-width:980px;margin:28px auto;padding:0 16px}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;align-items:center;gap:10px}
    .dot{width:12px;height:12px;border-radius:50%;background:var(--brand-red);box-shadow:0 0 0 3px rgba(255,59,48,.15)}
    .card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    h1{font-size:22px;margin:0;font-weight:800}
    h2{font-size:16px;margin:0 0 10px;font-weight:800}
    label{display:block;font-size:13px;font-weight:600;margin:14px 0 6px}
    input[type="text"],input[type="email"],input[type="password"],textarea,.pill{
      width:100%;padding:12px 14px;border:1px solid var(--stroke);border-radius:12px;background:#fff;font:inherit
    }
    textarea{min-height:90px;resize:vertical}
    .grid{display:grid;grid-template-columns:1fr 300px;gap:16px}
    .right{position:sticky;top:16px;height:fit-content}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:11px 16px;border-radius:12px;border:1px solid var(--stroke);cursor:pointer;font-weight:700}
    .btn.primary{background:#111;color:#fff}
    .btn.secondary{background:#fff;color:#111}
    .btn.danger{background:linear-gradient(180deg, rgba(255,59,48,.08), transparent), #111;color:#fff}
    .hint{font-size:12px;color:var(--muted)}
    .ok{color:#0a8f3c}.err{color:#c62828}
    .files{padding:12px;border:1px dashed #c9ced6;border-radius:12px;background:#f9fafb}
    .files.drag{background:#eef7ff;border-color:#8ab6ff}
    .file-list{margin:8px 0 0;padding:0;list-style:none;font-size:14px}
    .file-list li{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #eee}
    .pill{display:flex;gap:8px;flex-wrap:wrap;min-height:46px;background:#fff}
    .chip{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#f0f3f6;border:1px solid #d9e1ea}
    .chip b{font-weight:600}.chip button{border:0;background:none;cursor:pointer;font-size:16px;line-height:1}
    .auth{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .divider{height:1px;background:#e5e9ef;margin:12px 0}
    .badge{display:inline-block;background:#111;color:#fff;padding:3px 8px;border-radius:999px;font-size:12px;font-weight:700}
    .muted{opacity:.7}
  </style>
</head>
<body>
<div class="wrap">

  <div class="header">
    <div class="brand">
      <span class="dot"></span>
      <div>
        <div style="font-weight:800;letter-spacing:.2px">СкладСборка — Web</div>
        <div class="hint">Glass A-1</div>
      </div>
    </div>
    <div id="authState" class="hint">Не вошли</div>
  </div>

  <!-- Авторизация e-mail/пароль + анонимный вход -->
  <div class="card" id="authCard">
    <h2>Вход</h2>
    <div class="auth">
      <div>
        <label>E-mail</label>
        <input id="email" type="email" placeholder="you@company.ru" autocomplete="username">
      </div>
      <div>
        <label>Пароль</label>
        <input id="pass" type="password" placeholder="Пароль" autocomplete="current-password">
      </div>
    </div>
    <div class="toolbar" style="margin-top:12px">
      <button id="btnSignIn" class="btn primary">Войти</button>
      <button id="btnSignUp" class="btn secondary">Создать аккаунт</button>
      <button id="btnAnon" class="btn secondary">Войти анонимно</button>
      <button id="btnLogout" class="btn secondary">Выйти</button>
    </div>
    <div id="authMsg" class="hint" style="margin-top:8px"></div>
    <div class="divider"></div>
    <div class="hint">Если надо поменять конфиг (Firebase/Cloudinary/Notify) — жми <a href="#" id="openSetup">настройки</a>.</div>
  </div>

  <div style="height:12px"></div>

  <!-- Создание задачи -->
  <div class="card" id="taskCard" style="display:none">
    <h1>Создать задачу</h1>
    <label>Заголовок</label>
    <input id="title" type="text" placeholder="Например: Заказ №1234">

    <label>Комментарий</label>
    <textarea id="comment" placeholder="Ссылки, уточнения, примечания…"></textarea>

    <div class="grid" style="margin-top:12px">
      <div>
        <label>Исполнители (необязательно)</label>
        <div id="assignees" class="pill" aria-label="Исполнители"></div>
        <div class="toolbar" style="margin-top:10px">
          <button id="pickUsers" class="btn secondary">Выбрать исполнителей</button>
          <button id="clearUsers" class="btn secondary">Очистить</button>
        </div>

        <label style="margin-top:16px">Статус сборки</label>
        <div class="toolbar">
          <label style="display:inline-flex;align-items:center;gap:8px">
            <input id="assembled" type="checkbox"> <span>Собранный заказ</span>
          </label>
        </div>

        <label style="margin-top:16px">Файлы (PDF/изображения)</label>
        <div id="drop" class="files" tabindex="0">
          Перетащите файлы сюда или <label for="file" style="display:inline;color:#0b57d0;cursor:pointer;text-decoration:underline;margin:0">выберите</label>.
          <input id="file" type="file" multiple accept="image/*,.pdf" style="display:none">
          <ul id="list" class="file-list"></ul>
          <div class="hint">PDF → <b>raw</b> в Cloudinary, остальные — как <b>image</b>. Папка: <code>tasks/&lt;taskId&gt;</code></div>
        </div>
      </div>

      <div class="right">
        <div class="toolbar">
          <button id="save" class="btn danger">Сохранить задачу</button>
        </div>
        <div id="status" class="hint" style="margin-top:12px"></div>
        <div style="margin-top:14px">
          <span class="badge" id="who"></span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== Firebase SDK (modular v9) ===== -->
<script type="module">
  // ==== Мастер-настройка (хранится в localStorage) ====
  const SAVED = JSON.parse(localStorage.getItem("wct_config")||"null");

  const FIREBASE_CONFIG = SAVED?.firebase || {
    // Подставь свои при первом запуске через "Настройки"
    apiKey: "",
    authDomain: "",
    projectId: "",
    storageBucket: "",
    appId: ""
  };
  const CLOUDINARY = SAVED?.cloudinary || {
    cloudName: "",
    uploadPreset: "unsigned_tasks",
    folderPrefix: "tasks"
  };
  const NOTIFY_ENDPOINT = (SAVED?.notifyUrl) || "https://skladsborka-notify.vercel.app/api/notify-taskCreated";

  // Показать мастер-настройку, если чего-то нет
  function openSetupDialog(prefill = true){
    const dlg = document.createElement("dialog");
    dlg.style.cssText = "border:none;border-radius:14px;width:min(760px,96vw);padding:0";
    dlg.innerHTML = `
      <form method="dialog" style="padding:16px 16px 10px;font-family:Inter,system-ui">
        <h3 style="margin:4px 0 12px;font-weight:800">Настройки</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <h4 style="margin:8px 0">Firebase</h4>
            <label>apiKey <input id="f_apiKey" style="width:100%"></label>
            <label>authDomain <input id="f_authDomain" style="width:100%"></label>
            <label>projectId <input id="f_projectId" style="width:100%"></label>
            <label>storageBucket <input id="f_storageBucket" style="width:100%"></label>
            <label>appId <input id="f_appId" style="width:100%"></label>
          </div>
          <div>
            <h4 style="margin:8px 0">Cloudinary</h4>
            <label>cloudName <input id="c_cloudName" style="width:100%"></label>
            <label>uploadPreset <input id="c_uploadPreset" value="unsigned_tasks" style="width:100%"></label>
            <label>folderPrefix <input id="c_folder" value="tasks" style="width:100%"></label>
            <h4 style="margin:12px 0 4px">Notify</h4>
            <label>notify URL <input id="n_url" value="${NOTIFY_ENDPOINT}" style="width:100%"></label>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;gap:8px;margin-top:12px">
          <button id="resetCfg" value="reset" class="btn secondary">Сбросить</button>
          <div>
            <button value="cancel" class="btn secondary">Отмена</button>
            <button id="ok" value="ok" class="btn primary">Сохранить</button>
          </div>
        </div>
      </form>`;
    document.body.appendChild(dlg);

    if (prefill){
      dlg.querySelector("#f_apiKey").value = FIREBASE_CONFIG.apiKey || "";
      dlg.querySelector("#f_authDomain").value = FIREBASE_CONFIG.authDomain || "";
      dlg.querySelector("#f_projectId").value = FIREBASE_CONFIG.projectId || "";
      dlg.querySelector("#f_storageBucket").value = FIREBASE_CONFIG.storageBucket || "";
      dlg.querySelector("#f_appId").value = FIREBASE_CONFIG.appId || "";
      dlg.querySelector("#c_cloudName").value = CLOUDINARY.cloudName || "";
      dlg.querySelector("#c_uploadPreset").value = CLOUDINARY.uploadPreset || "unsigned_tasks";
      dlg.querySelector("#c_folder").value = CLOUDINARY.folderPrefix || "tasks";
      dlg.querySelector("#n_url").value = NOTIFY_ENDPOINT || "";
    }

    dlg.querySelector("#resetCfg").addEventListener("click",(e)=>{
      e.preventDefault();
      localStorage.removeItem("wct_config");
      location.reload();
    });

    dlg.addEventListener("close", ()=>{
      if (dlg.returnValue!=="ok"){ dlg.remove(); return; }
      const cfg = {
        firebase: {
          apiKey: dlg.querySelector("#f_apiKey").value.trim(),
          authDomain: dlg.querySelector("#f_authDomain").value.trim(),
          projectId: dlg.querySelector("#f_projectId").value.trim(),
          storageBucket: dlg.querySelector("#f_storageBucket").value.trim(),
          appId: dlg.querySelector("#f_appId").value.trim(),
        },
        cloudinary: {
          cloudName: dlg.querySelector("#c_cloudName").value.trim(),
          uploadPreset: dlg.querySelector("#c_uploadPreset").value.trim() || "unsigned_tasks",
          folderPrefix: dlg.querySelector("#c_folder").value.trim() || "tasks"
        },
        notifyUrl: dlg.querySelector("#n_url").value.trim()
      };
      localStorage.setItem("wct_config", JSON.stringify(cfg));
      location.reload();
    });
    dlg.querySelector("#ok").addEventListener("click",(e)=>{
      const rq = ["#f_apiKey","#f_authDomain","#f_projectId","#f_storageBucket","#f_appId","#c_cloudName","#c_uploadPreset"];
      for (const id of rq) if (!dlg.querySelector(id).value.trim()) { e.preventDefault(); alert("Заполни обязательные поля"); return; }
    });
    dlg.showModal();
  }

  // Если конфиг не заполнен — сразу показать
  if (!FIREBASE_CONFIG.apiKey || !CLOUDINARY.cloudName) {
    window.addEventListener("DOMContentLoaded", ()=>openSetupDialog());
  }
  document.getElementById("openSetup").addEventListener("click",(e)=>{ e.preventDefault(); openSetupDialog(); });

  // ==== Firebase init ====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getFirestore, collection, doc, addDoc, setDoc, updateDoc, serverTimestamp, getDocs, query } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, signInAnonymously, updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  const app = initializeApp(FIREBASE_CONFIG);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ==== UI refs ====
  const $ = id=>document.getElementById(id);
  const authCard = $("authCard");
  const taskCard = $("taskCard");
  const authMsg = $("authMsg");
  const authState = $("authState");
  const who = $("who");

  $("btnSignIn").onclick = async ()=>{
    try{
      const email = $("email").value.trim();
      const pass = $("pass").value;
      if(!email||!pass) return msgErr("Укажи e-mail и пароль");
      await signInWithEmailAndPassword(auth, email, pass);
      msgOk("Вход выполнен");
    }catch(e){ msgErr(e.message); }
  };
  $("btnSignUp").onclick = async ()=>{
    try{
      const email = $("email").value.trim();
      const pass = $("pass").value;
      if(!email||!pass) return msgErr("Укажи e-mail и пароль");
      const cr = await createUserWithEmailAndPassword(auth, email, pass);
      // Можно подсветить имя из e-mail до @
      const displayName = email.split("@")[0];
      try{ await updateProfile(cr.user, { displayName }); }catch(_){}
      msgOk("Аккаунт создан и вошли");
    }catch(e){ msgErr(e.message); }
  };
  $("btnAnon").onclick = async ()=>{
    try{ await signInAnonymously(auth); msgOk("Анонимный вход"); }catch(e){ msgErr(e.message); }
  };
  $("btnLogout").onclick = ()=>signOut(auth).catch(e=>msgErr(e.message));

  onAuthStateChanged(auth, (user)=>{
    if (user){
      authState.textContent = `Вошли: ${user.displayName || user.email || ("Anon "+user.uid.slice(0,6))}`;
      who.textContent = user.displayName || user.email || ("Anon "+user.uid.slice(0,6));
      authCard.querySelectorAll("input,button").forEach(el=>el.disabled=false);
      taskCard.style.display = "";
    } else {
      authState.textContent = "Не вошли";
      who.textContent = "без входа (если разрешают правила)";
      taskCard.style.display = ""; // можно работать без входа, если rules позволяют
    }
  });

  function msgOk(t){ authMsg.innerHTML = `<span class="ok">${t}</span>`; }
  function msgErr(t){ authMsg.innerHTML = `<span class="err">${t}</span>`; }

  // ==== Users picker ====
  const selected = { files: [], assignees: [], assigneeNames: [] };
  $("pickUsers").onclick = async ()=>{
    try{
      const snap = await getDocs(query(collection(db,"users")));
      const items = [];
      snap.forEach(d=>{
        const id = d.id;
        const name = d.get("name") || d.get("displayName") || id;
        items.push({id,name});
      });
      items.sort((a,b)=>a.name.localeCompare(b.name,'ru'));
      const res = await showPicker(items, selected.assignees);
      if(!res) return;
      selected.assignees = res.map(x=>x.id);
      selected.assigneeNames = res.map(x=>x.name);
      renderAssignees();
    }catch(e){ statusErr("Не удалось загрузить пользователей: "+e.message); }
  };
  $("clearUsers").onclick = ()=>{ selected.assignees=[]; selected.assigneeNames=[]; renderAssignees(); };

  function renderAssignees(){
    const box = $("assignees");
    box.innerHTML="";
    if (selected.assignees.length===0){
      box.innerHTML = '<span class="hint">Исполнители не выбраны — задача уйдёт как <b>самовывоз</b> для всех</span>';
      return;
    }
    selected.assigneeNames.forEach((n,i)=>{
      const chip = document.createElement("span");
      chip.className="chip";
      chip.innerHTML = `<b>${escapeHtml(n)}</b> <button title="Убрать" aria-label="Убрать">&times;</button>`;
      chip.querySelector("button").onclick = ()=>{ selected.assignees.splice(i,1); selected.assigneeNames.splice(i,1); renderAssignees(); };
      box.appendChild(chip);
    });
  }

  // ==== Files (drop/choose) ====
  const drop = $("drop"), fileInput = $("file"), list = $("list");
  fileInput.onchange = ()=>addFiles([...fileInput.files]);
  ["dragenter","dragover"].forEach(ev => drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add("drag"); }));
  ["dragleave","drop"].forEach(ev => drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove("drag"); }));
  drop.addEventListener("drop", e=>addFiles([...e.dataTransfer.files]));

  function addFiles(files){
    for(const f of files){
      if(!f || !f.name) continue;
      if (selected.files.find(x=>x.name===f.name && x.size===f.size)) continue;
      selected.files.push(f);
    }
    renderFiles();
  }
  function renderFiles(){
    list.innerHTML="";
    selected.files.forEach((f, i)=>{
      const li = document.createElement("li");
      li.innerHTML = `<b>${escapeHtml(f.name)}</b> <small class="muted">${(f.size/1024/1024).toFixed(2)} MB</small>
        <button aria-label="Удалить" class="btn secondary" style="margin-left:auto">Удалить</button>`;
      li.querySelector("button").onclick = ()=>{ selected.files.splice(i,1); renderFiles(); };
      list.appendChild(li);
    });
  }

  // ==== Save task ====
  $("save").onclick = async ()=>{
    const title = $("title").value.trim();
    const comment = $("comment").value.trim();
    const isAssembled = $("assembled").checked;
    const user = auth.currentUser; // может быть null

    if(!title) return statusErr("Введите заголовок");
    $("save").disabled = true; status("Создаём задачу…");

    try{
      // 1) Создаём документ задачи
      const taskRef = await addDoc(collection(db,"tasks"), {
        title, comment,
        assignees: selected.assignees,
        assigneeNames: selected.assigneeNames,
        isPickup: selected.assignees.length===0,
        isAssembled: !!isAssembled,
        status: "assigned",
        createdAt: serverTimestamp(),
        creatorId: user?.uid || "web-desktop",
        creatorName: user?.displayName || user?.email || "Менеджер с ПК",
        files: []
      });

      // 2) Загружаем файлы
      const uploaded = [];
      for(let i=0;i<selected.files.length;i++){
        const f = selected.files[i];
        status(`Загрузка файлов: ${i+1}/${selected.files.length}…`);
        const up = await uploadToCloudinary(f, taskRef.id);
        uploaded.push(up);
      }

      // 3) Обновляем files
      if (uploaded.length>0){
        await updateDoc(doc(db,"tasks",taskRef.id), { files: uploaded, updatedAt: serverTimestamp() });
      }

      // 4) Пингануть нотификатор
      try{
        await fetch(NOTIFY_ENDPOINT, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({taskId: taskRef.id})});
      }catch(_){}

      statusOk("Готово: задача создана");
      $("title").value=""; $("comment").value=""; selected.files=[]; renderFiles();
      // Исполнителей не очищаем — удобно делать пачку
    }catch(e){
      statusErr("Ошибка сохранения: "+e.message);
    }finally{
      $("save").disabled = false;
    }
  };

  // ==== Cloudinary upload (unsigned) ====
  async function uploadToCloudinary(file, taskId){
    const name = file.name || "file";
    const isPdf = /\.pdf$/i.test(name);
    const resource = isPdf ? "raw" : "auto";
    const url = `https://api.cloudinary.com/v1_1/${encodeURIComponent(CLOUDINARY.cloudName)}/${resource}/upload`;
    const fd = new FormData();
    fd.append("file", file);
    fd.append("upload_preset", CLOUDINARY.uploadPreset);
    fd.append("folder", `${CLOUDINARY.folderPrefix}/${taskId}`);
    if (isPdf) fd.append("resource_type", "raw");
    const res = await fetch(url, { method:"POST", body: fd });
    if (!res.ok) throw new Error("Upload failed: "+res.status);
    const j = await res.json();
    let fileType = j.resource_type || (isPdf ? "raw" : "image");
    if (isPdf && fileType!=="raw") fileType = "pdf";
    return { url: j.secure_url, publicId: j.public_id, type: fileType, name };
  }

  // ==== status utils ====
  const statusEl = $("status");
  function status(t){ statusEl.innerHTML = t; statusEl.className="hint"; }
  function statusOk(t){ statusEl.innerHTML = `<span class="ok">${t}</span>`; statusEl.className="hint"; }
  function statusErr(t){ statusEl.innerHTML = `<span class="err">${t}</span>`; statusEl.className="hint"; }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

  // ==== простой модальный выбор пользователей ====
  function showPicker(items, preselected){
    return new Promise(resolve=>{
      const sel = new Set(preselected||[]);
      const dlg = document.createElement("dialog");
      dlg.style.padding="0"; dlg.style.border="none"; dlg.style.borderRadius="14px"; dlg.style.width="min(700px, 96vw)";
      dlg.innerHTML = `
        <form method="dialog" style="padding:16px 16px 10px">
          <h3 style="margin:4px 0 12px;font-weight:800">Выберите исполнителей</h3>
          <input id="filt" type="text" placeholder="Фильтр…" style="width:100%;padding:10px 12px;border:1px solid var(--stroke);border-radius:10px">
          <div id="lst" style="margin-top:10px;max-height:52vh;overflow:auto;border:1px solid #eee;border-radius:10px;padding:8px;background:#fafafa"></div>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
            <button value="cancel" class="btn secondary">Отмена</button>
            <button id="ok" value="ok" class="btn primary">Выбрать</button>
          </div>
        </form>`;
      document.body.appendChild(dlg);

      const lst = dlg.querySelector("#lst");
      const filt = dlg.querySelector("#filt");
      function renderList(){
        const q = (filt.value||"").toLowerCase();
        lst.innerHTML = "";
        items.forEach(it=>{
          if (q && !it.name.toLowerCase().includes(q) && !it.id.toLowerCase().includes(q)) return;
          const row = document.createElement("label");
          row.style.cssText = "display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid #eee;cursor:pointer";
          row.innerHTML = `<input type="checkbox" ${sel.has(it.id)?"checked":""}> <div><b>${escapeHtml(it.name)}</b><div class="hint">${escapeHtml(it.id)}</div></div>`;
          row.querySelector("input").onchange = (e)=>{ if(e.target.checked) sel.add(it.id); else sel.delete(it.id); };
          lst.appendChild(row);
        });
      }
      renderList();
      filt.oninput = renderList;

      dlg.addEventListener("close", ()=>{
        if (dlg.returnValue!=="ok"){ dlg.remove(); return resolve(null); }
        const res = items.filter(it=>sel.has(it.id));
        dlg.remove(); resolve(res);
      });
      dlg.showModal();
    });
  }
</script>
</body>
</html>

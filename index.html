<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Создать задачу — СкладСборка (PDF/IMG + DnD/Ctrl+V)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0b0f14; color: #fff; }
    .container { max-width: 1100px; margin: 24px auto 64px; padding: 0 16px; }
    h1 { margin: 0 0 16px; font-weight: 700; }
    .card { background:#0d1422; border:1px solid #1f2a44; border-radius:14px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .row > * { flex:1 1 auto }
    .dropzone { border: 2px dashed #4b5563; border-radius: 14px; padding: 22px; background: #111827; text-align: center; transition: .2s; position: relative; }
    .dropzone.drag { background: #1f2937; border-color: #60a5fa; }
    .hint { color:#9ca3af; font-size:13px; }
    label { font-size: 14px; color: #9ca3af; display:block; margin: 12px 0 6px;}
    input[type="text"], textarea {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #374151; background: #0b1220; color: #fff;
    }
    textarea { min-height: 80px; resize: vertical; }
    button { background: #3b82f6; border: 0; color: #fff; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; }
    button.ghost { background:#0b1220; border:1px solid #374151; }
    button[disabled] { opacity:.6; cursor: not-allowed }
    .status { margin-top: 8px; font-size: 14px; color: #93c5fd; white-space: pre-wrap; }
    .files { margin-top: 10px; }
    .fileRow { display:flex; align-items:center; gap:8px; margin:6px 0; padding:8px; border:1px solid #1f2a44; border-radius:10px; background:#0b1220; }
    .fileRow .name { flex:1 1 auto; }
    .fileRow .size { font-size:12px; opacity:.75 }
    .thumb { width:48px; height:48px; border-radius:8px; object-fit:cover; background:#0b0f14; border:1px solid #1f2a44 }
    .pdfBadge { width:48px; height:48px; border-radius:8px; display:flex; align-items:center; justify-content:center; background:#111827; border:1px solid #1f2a44; font-weight:800 }
    .muted { color:#9ca3af; font-size:13px }
    .chip { border:1px solid #374151; background:#0b1220; padding:8px 10px; border-radius:999px; cursor:pointer; }
    .chip.active { background:#1e293b; border-color:#60a5fa; }
    #fileInput { position: fixed; left: -9999px; top: -9999px; width: 1px; height: 1px; opacity: 0; }
  </style>
  <!-- Firebase dynamic modules; Cloudinary — через прямой REST -->
</head>
<body>
  <div class="container">
    <h1>Создать задачу (PDF/картинки: DnD + Ctrl+V)</h1>

    <div class="card">
      <div class="dropzone" id="drop">
        <p><b>Перетащите PDF/PNG/JPG/WebP (можно несколько)</b> или нажмите «Выбрать файлы».<br>
        <span class="hint">Можно вставлять скриншоты: <b>Ctrl + V</b> прямо сюда.</span></p>
        <div class="row" style="justify-content:center">
          <button id="btnPick" type="button" class="ghost">Выбрать файлы</button>
          <button id="btnClearFiles" type="button" class="ghost">Очистить список</button>
        </div>
        <input id="fileInput" type="file" multiple accept=".pdf,image/*" />
        <div id="filesList" class="files"></div>
        <div id="status" class="status"></div>
      </div>
    </div>

    <div class="card">
      <label>Заголовок</label>
      <input id="title" type="text" placeholder="Например: Отгрузка #1234" />
      <label>Комментарий</label>
      <textarea id="comment" placeholder="Склад, заказ №, контрагент — можно написать сюда"></textarea>
    </div>

    <div class="card">
      <label>Исполнители (кладовщики)</label>
      <div id="workersBox" class="row" style="gap:8px"></div>
      <div class="muted">Если никого не выбрать — будет самовывоз (одна задача без assignees).</div>
    </div>

    <div class="card" style="display:flex;gap:10px;justify-content:flex-end">
      <button id="btnCreate" type="button" disabled>Создать задачу</button>
    </div>
  </div>

  <script>
    // ====== Конфиг ======
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyAH58ZpWAp64mhM589KD6jXHcOlPqU0aYU",
      authDomain: "skladsborka-6c2a7.firebaseapp.com",
      projectId: "skladsborka-6c2a7",
      storageBucket: "skladsborka-6c2a7.appspot.com",
      messagingSenderId: "516526717198"
    };
    const CLOUDINARY_CLOUD_NAME    = "dnx1taqp7";
    const CLOUDINARY_UPLOAD_PRESET = "unsigned_tasks";
    const VERCEL_NOTIFY_PROXY_URL  = "/api/notify-taskCreated";

    // ====== Helpers ======
    const $ = s => document.querySelector(s);
    const status = t => { $('#status').textContent = t || ''; };
    const fmtSize = b => (b/1024/1024).toFixed(2)+' MB';
    const sleep = ms => new Promise(r=>setTimeout(r,ms));

    // ====== Firebase (lazy) ======
    let _app,_auth,_db,_firebase=null;
    async function ensureFirebase() {
      if (_firebase) return _firebase;
      const appMod  = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js");
      const authMod = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js");
      const fsMod   = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js");
      _app = appMod.initializeApp(FIREBASE_CONFIG);
      _auth = authMod.getAuth(_app);
      _db   = fsMod.getFirestore(_app);
      try { await authMod.signInAnonymously(_auth); } catch(e){ console.warn("Anon auth failed:", e); }
      _firebase = { appMod, authMod, fsMod };
      return _firebase;
    }

    // ====== Состояние файлов ======
    const drop = $('#drop');
    const fi   = $('#fileInput');
    const btnPick = $('#btnPick');
    const btnClear = $('#btnClearFiles');
    const btnCreate = $('#btnCreate');

    let filesAll = []; // [{file:File, name:string, typeHint:'pdf'|'image'}]

    btnPick.addEventListener('click', () => fi.click());
    btnClear.addEventListener('click', clearFiles);
    fi.addEventListener('change', () => handleFiles(fi.files));

    // DnD
    ['dragenter','dragover'].forEach(ev=>{
      document.addEventListener(ev, e=>{ e.preventDefault(); });
      drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); });
    });
    ['dragleave','drop'].forEach(ev=>{
      document.addEventListener(ev, e=>{ e.preventDefault(); });
      drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); });
    });
    drop.addEventListener('drop', e => { handleFiles(e.dataTransfer.files); });

    // Ctrl+V — скриншоты/изображения из буфера обмена
    document.addEventListener('paste', async (e) => {
      const items = e.clipboardData?.items || [];
      const add = [];
      for (const it of items) {
        if (it.kind === 'file' && it.type.startsWith('image/')) {
          const blob = it.getAsFile();
          if (blob) {
            const ts = new Date();
            const pad = n => String(n).padStart(2,'0');
            const name = `paste_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}.png`;
            const file = new File([blob], name, { type: blob.type || 'image/png' });
            add.push({file, name, typeHint:'image'});
          }
        }
      }
      if (add.length) {
        filesAll.push(...add);
        renderFilesList();
        updateCreateDisabled();
        status(`Добавлено из буфера: ${add.length}`);
      }
    });

    function clearFiles(){
      filesAll = [];
      $('#filesList').innerHTML = "";
      status('');
      updateCreateDisabled();
    }

    function handleFiles(fileList) {
      const arr = Array.from(fileList || []).filter(Boolean);
      if (!arr.length) return;
      for (const f of arr) {
        const lower = (f.name||'').toLowerCase();
        const isPdf = lower.endsWith('.pdf') || f.type === 'application/pdf';
        const typeHint = isPdf ? 'pdf' : 'image';
        filesAll.push({ file: f, name: f.name || 'file', typeHint });
      }
      renderFilesList();
      updateCreateDisabled();
      status(`Файлов выбрано: ${filesAll.length}`);
    }

    function renderFilesList(){
      const box = $('#filesList'); box.innerHTML = "";
      if (!filesAll.length) return;
      let idx = -1;
      for (const rec of filesAll) {
        idx++;
        const row = document.createElement('div');
        row.className = 'fileRow';

        let icon;
        if (rec.typeHint === 'pdf') {
          icon = document.createElement('div');
          icon.className = 'pdfBadge';
          icon.textContent = 'PDF';
        } else {
          icon = document.createElement('img');
          icon.className = 'thumb';
          try { icon.src = URL.createObjectURL(rec.file); } catch(_) {}
        }
        const name = document.createElement('div'); name.className='name'; name.textContent = rec.name || '(без имени)';
        const size = document.createElement('div'); size.className='size'; size.textContent = fmtSize(rec.file.size||0);
        const btnDel = document.createElement('button'); btnDel.type='button'; btnDel.className='ghost'; btnDel.textContent='Удалить';
        const thisIndex = idx;
        btnDel.onclick = () => { filesAll.splice(thisIndex,1); renderFilesList(); updateCreateDisabled(); };

        row.appendChild(icon); row.appendChild(name); row.appendChild(size); row.appendChild(btnDel);
        box.appendChild(row);
      }
    }

    function updateCreateDisabled() {
      const okTitle = $('#title').value.trim().length > 0;
      const okFiles = filesAll.length > 0;
      btnCreate.disabled = !(okTitle && okFiles);
    }
    $('#title').addEventListener('input', updateCreateDisabled);

    // ====== Users (кладовщики) ======
    let usersAll = [];  // {id, name, role}
    const selectedWorkerIds = new Set();
    const selectedWorkerNames = new Set();

    function renderWorkers() {
      const box = $('#workersBox'); box.innerHTML = "";
      const workers = usersAll.filter(u => (u.role||"").toLowerCase() === "кладовщик");
      (workers.length ? workers : usersAll).forEach(u => {
        const btn = document.createElement('button');
        btn.type = "button";
        btn.textContent = u.name || u.id;
        btn.className = "chip";
        let active = false;
        function setActive(a){ active = a; if (a) btn.classList.add('active'); else btn.classList.remove('active'); }
        btn.onclick = () => {
          if (!active) { selectedWorkerIds.add(u.id); selectedWorkerNames.add(u.name || u.id); }
          else         { selectedWorkerIds.delete(u.id); selectedWorkerNames.delete(u.name || u.id); }
          setActive(!active);
        };
        box.appendChild(btn);
      });
    }
    async function loadUsers() {
      try {
        const { fsMod } = await ensureFirebase();
        const snap = await fsMod.getDocs(fsMod.collection(_db, 'users'));
        usersAll = snap.docs.map(d => ({
          id: d.id,
          name: d.get('name') || d.get('displayName') || d.id,
          role: (d.get('role') || "").toString()
        }));
        renderWorkers();
      } catch (e) {
        console.error("loadUsers failed:", e);
        $('#workersBox').innerHTML = '<div class="muted">Не удалось загрузить пользователей</div>';
      }
    }

    // ====== Cloudinary upload ======
    async function uploadToCloudinary(file, taskId, typeHint) {
      const form = new FormData();
      form.append('file', file);
      form.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
      form.append('folder', `tasks/${taskId}`);
      // auto/upload сам определит resource_type; PDF иногда идёт как raw
      const resp = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`, { method:'POST', body: form });
      if (!resp.ok) throw new Error('Cloudinary upload failed: ' + resp.status);
      const j = await resp.json();
      const url = j.secure_url || "";
      const publicId = j.public_id || "";
      const rtype = (j.resource_type || '').toLowerCase(); // image/raw
      const isPdfByName = (file.name||'').toLowerCase().endsWith('.pdf') || typeHint === 'pdf';
      const fixedUrl = isPdfByName && url.includes("/image/upload/") ? url.replace("/image/upload/", "/raw/upload/") : url;
      const typeForTask = isPdfByName ? "pdf" : (rtype === "image" ? "image" : (rtype || "raw"));
      return { url: fixedUrl, publicId, type: typeForTask, name: file.name || (isPdfByName ? 'document.pdf' : 'image.jpg') };
    }
    async function uploadAllToCloudinary(taskId) {
      const out = [];
      let i=0;
      for (const rec of filesAll) {
        i++;
        status(`Загрузка файлов ${i}/${filesAll.length}…`);
        out.push(await uploadToCloudinary(rec.file, taskId, rec.typeHint));
        await sleep(30);
      }
      return out;
    }

    // ====== Создание задач ======
    async function createOneTaskFor(fsMod, title, comment, assigneeId, assigneeName, isPickup) {
      const docRef = fsMod.doc(fsMod.collection(_db, 'tasks'));
      const taskId = docRef.id;
      const data = {
        title, comment,
        assignees: assigneeId ? [assigneeId] : [],
        assigneeNames: assigneeName ? [assigneeName] : [],
        isPickup: !!isPickup,
        status: "assigned",
        createdAt: fsMod.serverTimestamp(),
        creatorId: "unknown",
        creatorName: "unknown",
        items: [], // без парсинга — пустой список
        source: "web-simple-files",
        sourceMeta: { ua: navigator.userAgent, filesCount: filesAll.length },
        files: []
      };
      await fsMod.setDoc(docRef, data);
      const fileRecs = await uploadAllToCloudinary(taskId);
      await fsMod.updateDoc(docRef, { files: fileRecs });

      try {
        await fetch(VERCEL_NOTIFY_PROXY_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ taskId, assigneeIds: assigneeId ? [assigneeId] : [] })
        });
      } catch(e) { console.warn('notify failed', e); }
      return taskId;
    }

    async function createTask() {
      try {
        const title = $('#title').value.trim();
        const comment = $('#comment').value.trim();
        if (!title) { alert('Введите заголовок'); return; }
        if (!filesAll.length) { alert('Добавьте файл(ы)'); return; }

        btnCreate.disabled = true;
        status('Создаю задачу(и)…');

        const { fsMod } = await ensureFirebase();
        const workerIds = Array.from(selectedWorkerIds);
        const workerNames = Array.from(selectedWorkerNames);

        const createdIds = [];
        if (workerIds.length === 0) {
          const id = await createOneTaskFor(fsMod, title, comment, null, null, true);
          createdIds.push(id);
        } else {
          for (let i=0;i<workerIds.length;i++){
            const id = await createOneTaskFor(fsMod, title, comment, workerIds[i], workerNames[i] || workerIds[i], false);
            createdIds.push(id);
          }
        }

        status(`Готово. Создано задач: ${createdIds.length}`);
        alert(`Создано задач: ${createdIds.length}`);

        // reset
        clearFiles();
        $('#title').value = "";
        $('#comment').value = "";
        selectedWorkerIds.clear(); selectedWorkerNames.clear();
        renderWorkers(); // сброс визуальных чипсов
        updateCreateDisabled();
      } catch (e) {
        console.error(e);
        alert('Ошибка: ' + (e?.message||e));
        status('Ошибка');
        updateCreateDisabled();
      } finally {
        btnCreate.disabled = false;
      }
    }
    btnCreate.addEventListener('click', createTask);

    // ====== Init ======
    (async function init(){
      await ensureFirebase();
      await loadUsers();
      updateCreateDisabled();
      status('Готово к работе. Перетащите PDF/картинки или вставьте скриншот (Ctrl+V).');
    })();
  </script>
</body>
</html>

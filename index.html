<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Создать задачу — СкладСборка (PDF/IMG + DnD/Ctrl+V)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0b0f14; color: #fff; }
    .container { max-width: 1100px; margin: 24px auto 64px; padding: 0 16px; }
    h1 { margin: 0 0 16px; font-weight: 700; }
    .card { background:#0d1422; border:1px solid #1f2a44; border-radius:14px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .dropzone { border:2px dashed #4b5563; border-radius:14px; padding:22px; background:#111827; text-align:center; transition:.2s; position:relative; }
    .dropzone.drag { background:#1f2937; border-color:#60a5fa; }
    .hint { color:#9ca3af; font-size:13px; }
    label { font-size:14px; color:#9ca3af; display:block; margin:12px 0 6px;}
    input[type="text"], textarea {
      width:100%; padding:10px 12px; border-radius:10px;
      border:1px solid #374151; background:#0b1220; color:#fff;
    }
    textarea { min-height:80px; resize:vertical; }
    button { background:#3b82f6; border:0; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    button.ghost { background:#0b1220; border:1px solid #374151; }
    button[disabled] { opacity:.6; cursor:not-allowed }
    .status { margin-top:8px; font-size:14px; color:#93c5fd; white-space:pre-wrap; }
    .files { margin-top:10px; }
    .fileRow { display:flex; align-items:center; gap:8px; margin:6px 0; padding:8px;
      border:1px solid #1f2a44; border-radius:10px; background:#0b1220; }
    .fileRow .name { flex:1 1 auto; }
    .fileRow .size { font-size:12px; opacity:.75 }
    .thumb { width:48px; height:48px; border-radius:8px; object-fit:cover; background:#0b0f14; border:1px solid #1f2a44 }
    .pdfBadge { width:48px; height:48px; border-radius:8px; display:flex; align-items:center; justify-content:center;
      background:#111827; border:1px solid #1f2a44; font-weight:800 }
    .muted { color:#9ca3af; font-size:13px }
    .chip { border:1px solid #374151; background:#0b1220; padding:8px 10px; border-radius:999px; cursor:pointer; }
    .chip.active { background:#1e293b; border-color:#60a5fa; }
    #fileInput { position:fixed; left:-9999px; top:-9999px; width:1px; height:1px; opacity:0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Создать задачу (PDF/картинки: DnD + Ctrl+V)</h1>

    <div class="card">
      <div class="dropzone" id="drop">
        <p><b>Перетащите PDF/PNG/JPG/WebP (можно несколько)</b> или нажмите «Выбрать файлы».<br>
        <span class="hint">Можно вставлять скриншоты: <b>Ctrl + V</b> прямо сюда.</span></p>
        <div class="row" style="justify-content:center">
          <button id="btnPick" type="button" class="ghost">Выбрать файлы</button>
          <button id="btnClearFiles" type="button" class="ghost">Очистить список</button>
        </div>
        <input id="fileInput" type="file" multiple accept=".pdf,image/*" />
        <div id="filesList" class="files"></div>
        <div id="status" class="status"></div>
      </div>
    </div>

    <div class="card">
      <label>Заголовок</label>
      <input id="title" type="text" placeholder="Например: Отгрузка #1234" />
      <label>Комментарий</label>
      <textarea id="comment" placeholder="Склад, заказ №, контрагент — можно написать сюда"></textarea>
    </div>

    <div class="card">
      <label>Исполнители (кладовщики)</label>
      <div id="workersBox" class="row" style="gap:8px"></div>
      <div class="muted">Если никого не выбрать — будет самовывоз (одна задача без assignees).</div>
    </div>

    <div class="card" style="display:flex;gap:10px;justify-content:flex-end">
      <button id="btnCreate" type="button" disabled>Создать задачу</button>
    </div>
  </div>

  <script>
    // ===== Конфиг =====
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyAH58ZpWAp64mhM589KD6jXHcOlPqU0aYU",
      authDomain: "skladsborka-6c2a7.firebaseapp.com",
      projectId: "skladsborka-6c2a7",
      storageBucket: "skladsborka-6c2a7.appspot.com",
      messagingSenderId: "516526717198"
    };
    const CLOUDINARY_CLOUD_NAME    = "dnx1taqp7";
    const CLOUDINARY_UPLOAD_PRESET = "unsigned_tasks";
    const DIRECT_NOTIFY_URL = "https://version-pi.vercel.app/notify/taskCreated";

    const $ = s => document.querySelector(s);
    const status = t => $('#status').textContent = t || '';
    const sleep = ms => new Promise(r => setTimeout(r, ms));
    const fmtSize = b => (b/1024/1024).toFixed(2)+' MB';

    // ===== Firebase =====
    let _app,_auth,_db,_firebase=null;
    async function ensureFirebase() {
      if (_firebase) return _firebase;
      const appMod  = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js");
      const authMod = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js");
      const fsMod   = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js");
      _app = appMod.initializeApp(FIREBASE_CONFIG);
      _auth = authMod.getAuth(_app);
      _db   = fsMod.getFirestore(_app);
      try { await authMod.signInAnonymously(_auth); } catch(e){ console.warn("Anon auth failed:", e); }
      _firebase = { appMod, authMod, fsMod };
      return _firebase;
    }

    // ===== Файлы =====
    const drop = $('#drop');
    const fi   = $('#fileInput');
    const btnPick = $('#btnPick');
    const btnClear = $('#btnClearFiles');
    const btnCreate = $('#btnCreate');
    let filesAll = [];

    btnPick.onclick = () => fi.click();
    btnClear.onclick = clearFiles;
    fi.onchange = () => handleFiles(fi.files);

    ['dragenter','dragover'].forEach(ev=>{
      document.addEventListener(ev,e=>e.preventDefault());
      drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.add('drag');});
    });
    ['dragleave','drop'].forEach(ev=>{
      document.addEventListener(ev,e=>e.preventDefault());
      drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove('drag');});
    });
    drop.addEventListener('drop', e => handleFiles(e.dataTransfer.files));

    // Ctrl+V вставка изображений
    document.addEventListener('paste', e => {
      const items = e.clipboardData?.items || [];
      for (const it of items) {
        if (it.kind === 'file' && it.type.startsWith('image/')) {
          const blob = it.getAsFile();
          if (!blob) continue;
          const ts = Date.now();
          const f = new File([blob], `paste_${ts}.png`, {type:blob.type});
          filesAll.push({file:f,name:f.name,typeHint:'image'});
        }
      }
      renderFilesList(); updateCreateDisabled();
    });

    function handleFiles(list){
      const arr = Array.from(list||[]);
      for (const f of arr){
        const isPdf = /\.pdf$/i.test(f.name) || f.type==='application/pdf';
        filesAll.push({file:f,name:f.name,typeHint:isPdf?'pdf':'image'});
      }
      renderFilesList(); updateCreateDisabled();
    }
    function clearFiles(){
      filesAll=[]; $('#filesList').innerHTML=""; status(''); updateCreateDisabled();
    }
    function renderFilesList(){
      const box=$('#filesList'); box.innerHTML="";
      filesAll.forEach((rec,i)=>{
        const row=document.createElement('div'); row.className='fileRow';
        const icon = rec.typeHint==='pdf'
          ? Object.assign(document.createElement('div'),{className:'pdfBadge',textContent:'PDF'})
          : Object.assign(document.createElement('img'),{className:'thumb',src:URL.createObjectURL(rec.file)});
        const name=document.createElement('div'); name.className='name'; name.textContent=rec.name;
        const size=document.createElement('div'); size.className='size'; size.textContent=fmtSize(rec.file.size);
        const del=document.createElement('button'); del.type='button'; del.className='ghost'; del.textContent='Удалить';
        del.onclick=()=>{filesAll.splice(i,1);renderFilesList();updateCreateDisabled();};
        row.append(icon,name,size,del); box.append(row);
      });
    }

    function updateCreateDisabled(){
      const okTitle=$('#title').value.trim().length>0;
      btnCreate.disabled=!(okTitle&&filesAll.length);
    }
    $('#title').addEventListener('input',updateCreateDisabled);

    // ===== Workers =====
    let usersAll=[], selectedWorkerIds=new Set(), selectedWorkerNames=new Set();
    async function loadUsers(){
      try{
        const {fsMod}=await ensureFirebase();
        const snap=await fsMod.getDocs(fsMod.collection(_db,'users'));
        usersAll=snap.docs.map(d=>({id:d.id,name:d.get('name')||d.id,role:(d.get('role')||"")}));
        renderWorkers();
      }catch(e){$('#workersBox').innerHTML='<div class="muted">Не удалось загрузить пользователей</div>';}
    }
    function renderWorkers(){
      const box=$('#workersBox'); box.innerHTML="";
      const workers=usersAll.filter(u=>(u.role||"").toLowerCase()==='кладовщик');
      (workers.length?workers:usersAll).forEach(u=>{
        const btn=document.createElement('button'); btn.type='button'; btn.textContent=u.name||u.id; btn.className='chip';
        let act=false;
        btn.onclick=()=>{
          if(!act){selectedWorkerIds.add(u.id);selectedWorkerNames.add(u.name||u.id);} 
          else{selectedWorkerIds.delete(u.id);selectedWorkerNames.delete(u.name||u.id);}
          act=!act; btn.classList.toggle('active',act);
        };
        box.append(btn);
      });
    }

    // ===== Cloudinary =====
    async function uploadToCloudinary(file,taskId){
      const isPdf=/\.pdf$/i.test(file.name)||file.type==='application/pdf';
      const endpoint=isPdf?'raw':'auto';
      const form=new FormData();
      form.append('file',file);
      form.append('upload_preset',CLOUDINARY_UPLOAD_PRESET);
      form.append('folder',`tasks/${taskId}`);
      const resp=await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${endpoint}/upload`,{method:'POST',body:form});
      if(!resp.ok)throw new Error('Cloudinary upload failed '+resp.status);
      const j=await resp.json();
      const type=isPdf||((j.format||'').toLowerCase()==='pdf')?'pdf':(j.resource_type||'image');
      return{url:j.secure_url||"",publicId:j.public_id||"",type,name:file.name||'file'};
    }
    async function uploadAllToCloudinary(taskId){
      const out=[];
      for(let i=0;i<filesAll.length;i++){
        status(`Загрузка файлов ${i+1}/${filesAll.length}…`);
        out.push(await uploadToCloudinary(filesAll[i].file,taskId));
        await sleep(30);
      }
      return out;
    }

    // ===== Создание задачи =====
    async function createOneTaskFor(fsMod,title,comment,assigneeId,assigneeName,isPickup){
      const docRef=fsMod.doc(fsMod.collection(_db,'tasks'));
      const taskId=docRef.id;
      const data={
        title,comment,
        assignees:assigneeId?[assigneeId]:[],
        assigneeNames:assigneeName?[assigneeName]:[],
        isPickup:!!isPickup,
        status:"assigned",
        createdAt:fsMod.serverTimestamp(),
        creatorId:"unknown",
        creatorName:"unknown",
        items:[],
        source:"web-simple-files",
        sourceMeta:{ua:navigator.userAgent,filesCount:filesAll.length},
        files:[]
      };
      await fsMod.setDoc(docRef,data);
      const fileRecs=await uploadAllToCloudinary(taskId);
      await fsMod.updateDoc(docRef,{files:fileRecs});
      try{
        const resp=await fetch(DIRECT_NOTIFY_URL,{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({taskId,assigneeIds:assigneeId?[assigneeId]:[]})
        });
        if(!resp.ok){
          const txt=await resp.text().catch(()=> ''); 
          console.warn('notify failed',resp.status,txt);
          status(`Внимание: notify ${resp.status}`);
        }
      }catch(e){console.warn('notify error',e);status('Внимание: notify error');}
      return taskId;
    }

    async function createTask(){
      try{
        const title=$('#title').value.trim(), comment=$('#comment').value.trim();
        if(!title)return alert('Введите заголовок');
        if(!filesAll.length)return alert('Добавьте файл(ы)');
        btnCreate.disabled=true; status('Создаю задачу…');
        const {fsMod}=await ensureFirebase();
        const wIds=[...selectedWorkerIds], wNames=[...selectedWorkerNames];
        const ids=[];
        if(!wIds.length){ids.push(await createOneTaskFor(fsMod,title,comment,null,null,true));}
        else for(let i=0;i<wIds.length;i++) ids.push(await createOneTaskFor(fsMod,title,comment,wIds[i],wNames[i]||wIds[i],false));
        alert(`Создано задач: ${ids.length}`);
        status(`Готово. Создано задач: ${ids.length}`);
        clearFiles(); $('#title').value=""; $('#comment').value="";
        selectedWorkerIds.clear(); selectedWorkerNames.clear(); renderWorkers(); updateCreateDisabled();
      }catch(e){console.error(e);alert('Ошибка: '+(e.message||e));status('Ошибка');}
      finally{btnCreate.disabled=false;}
    }
    btnCreate.onclick=createTask;

    // ===== Init =====
    (async()=>{await ensureFirebase();await loadUsers();updateCreateDisabled();
      status('Готово к работе. Перетащите PDF/картинки или вставьте скриншот (Ctrl+V).');
    })();
  </script>
</body>
</html>

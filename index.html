<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Создать задачу — СкладСборка</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0b0f14; color: #fff; }
    .container { max-width: 1100px; margin: 24px auto 64px; padding: 0 16px; }
    h1 { margin: 0 0 16px; }
    .card { background:#0d1422; border:1px solid #1f2a44; border-radius:14px; padding:16px; margin-bottom:16px; }
    label { font-size:14px; color:#9ca3af; display:block; margin:10px 0 6px; }
    input[type="text"], textarea { width:100%; padding:10px 12px; border-radius:10px; border:1px solid #374151; background:#0b1220; color:#fff; }
    textarea { min-height:80px; resize:vertical; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .dropzone { border:2px dashed #4b5563; border-radius:14px; padding:22px; background:#111827; text-align:center; transition:.2s; }
    .dropzone.drag { background:#1f2937; border-color:#60a5fa; }
    .muted { color:#9ca3af; font-size:13px }
    button { background:#3b82f6; border:0; color:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    button.ghost { background:#0b1220; border:1px solid #374151; }
    button[disabled] { opacity:.6; cursor:not-allowed }
    #fileInput { position:fixed; left:-9999px; top:-9999px; width:1px; height:1px; opacity:0; }
    .files { margin-top:10px; display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:10px; }
    .file { display:flex; gap:10px; align-items:center; padding:8px; border:1px solid #1f2a44; border-radius:10px; background:#0b1220; }
    .thumb { width:48px; height:48px; border-radius:8px; background:#111827; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .thumb img { max-width:100%; max-height:100%; display:block; }
    .pdfBadge { font-size:12px; font-weight:700; padding:2px 6px; border-radius:6px; background:#b91c1c; }
    .fname { font-weight:600; }
    .fmeta { font-size:12px; opacity:.75 }
    .grow { flex:1 1 auto; min-width:0 }
    .chip { border:1px solid #374151; background:#0b1220; padding:8px 10px; border-radius:999px; cursor:pointer; }
    .chip.active { background:#1e293b; border-color:#60a5fa; }
    .status { margin-top:8px; font-size:14px; color:#93c5fd; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Создать задачу (скриншоты & PDF)</h1>

    <div class="card">
      <div class="dropzone" id="drop">
        <p><b>Перетащи сюда изображения или PDF</b>, нажми «Выбрать файлы»<br>или просто <b>Ctrl+V</b> — вставь принтскрин из буфера.</p>
        <div class="row" style="justify-content:center">
          <button id="btnPick" type="button" class="ghost">Выбрать файлы</button>
          <button id="btnClear" type="button" class="ghost">Очистить</button>
        </div>
        <input id="fileInput" type="file" multiple accept="image/*,application/pdf" />
        <div id="files" class="files"></div>
        <div id="status" class="status"></div>
      </div>
      <div class="muted" style="margin-top:8px">
        Поддерживаются: PNG, JPG, WebP, HEIC/HEIF (если браузер отдаёт), и PDF. Вставка из буфера — как изображение.
      </div>
    </div>

    <div class="card">
      <label>Заголовок</label>
      <input id="title" type="text" placeholder="Например: Отгрузка #1234" />
      <label>Комментарий</label>
      <textarea id="comment" placeholder="Склад, заказ №, контрагент — опционально"></textarea>
    </div>

    <div class="card">
      <label>Исполнители (кладовщики)</label>
      <div id="workers" class="row" style="gap:8px"></div>
      <div class="muted">Если никого не выбрать — создадим одну задачу для самовывоза (без исполнителей).</div>
    </div>

    <div class="card" style="display:flex; gap:10px; justify-content:flex-end">
      <button id="btnCreate" type="button" disabled>Создать задачу</button>
    </div>
  </div>

  <script>
    // ===== Конфиг
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyAH58ZpWAp64mhM589KD6jXHcOlPqU0aYU",
      authDomain: "skladsborka-6c2a7.firebaseapp.com",
      projectId: "skladsborka-6c2a7",
      storageBucket: "skladsborka-6c2a7.appspot.com",
      messagingSenderId: "516526717198"
    };
    const CONFIG = {
      cloudinary: { cloudName: "dnx1taqp7", uploadPreset: "unsigned_tasks" },
      notifyUrl: "https://skladsborka-notify.vercel.app/api/notify-taskCreated"
    };

    // ===== Утилиты
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const status = t => { $('#status').textContent = t || ''; };
    const sleep = ms => new Promise(r=>setTimeout(r,ms));
    function fmtSize(bytes){ return (bytes/1024/1024).toFixed(2)+' MB'; }
    function blobToFile(blob, name){ return new File([blob], name, { type: blob.type || 'application/octet-stream' }); }
    function isPdfByName(file){ return /\.pdf$/i.test(file?.name || ''); }

    // ===== Состояние файлов
    let filesAll = [];

    function clearAll(){
      filesAll = [];
      renderFiles();
      status('');
      updateCreateDisabled();
    }

    function renderFiles(){
      const box = $('#files'); box.innerHTML = '';
      for (const f of filesAll){
        const row = document.createElement('div'); row.className = 'file';
        const th = document.createElement('div'); th.className = 'thumb';
        if ((f.type||'').toLowerCase().startsWith('image/')){
          const img = document.createElement('img'); img.src = URL.createObjectURL(f);
          th.appendChild(img);
        } else {
          const badge = document.createElement('div'); badge.className = 'pdfBadge'; badge.textContent = 'PDF';
          th.appendChild(badge);
        }
        const center = document.createElement('div'); center.className = 'grow';
        const name = document.createElement('div'); name.className='fname'; name.textContent = f.name || '(без имени)';
        const meta = document.createElement('div'); meta.className='fmeta'; meta.textContent = `${f.type || 'unknown'} • ${fmtSize(f.size)}`;
        center.appendChild(name); center.appendChild(meta);
        const rm = document.createElement('button'); rm.type='button'; rm.className='ghost'; rm.textContent='Удалить';
        rm.onclick = () => { filesAll = filesAll.filter(x => x !== f); renderFiles(); updateCreateDisabled(); };
        row.appendChild(th); row.appendChild(center); row.appendChild(rm);
        box.appendChild(row);
      }
    }

    // ===== DnD / Pick / Paste
    const drop = $('#drop'); const fi = $('#fileInput');
    $('#btnPick').addEventListener('click', () => fi.click());
    $('#btnClear').addEventListener('click', clearAll);

    function isPdfFile(file){ return (file?.type||'').toLowerCase()==='application/pdf' || isPdfByName(file); }
    function acceptFile(file){
      if (!file) return false;
      const t = (file.type || '').toLowerCase();
      return t.startsWith('image/') || isPdfFile(file);
    }
    function addFiles(list){
      const arr = Array.from(list || []).filter(acceptFile);
      if (arr.length){ filesAll.push(...arr); renderFiles(); updateCreateDisabled(); }
    }
    ['dragenter','dragover'].forEach(ev=>{
      document.addEventListener(ev, e=>{ e.preventDefault(); });
      drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); });
    });
    ['dragleave','drop'].forEach(ev=>{
      document.addEventListener(ev, e=>{ e.preventDefault(); });
      drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); });
    });
    drop.addEventListener('drop', e => addFiles(e.dataTransfer?.files));
    fi.addEventListener('change', () => addFiles(fi.files));
    window.addEventListener('paste', async (e) => {
      const items = Array.from(e.clipboardData?.items || []);
      const files = [];
      for (const it of items) if (it.kind === 'file') {
        const f = it.getAsFile(); if (acceptFile(f)) files.push(f);
      }
      if (!files.length) return;
      const now = new Date(); let idx = 1;
      const named = await Promise.all(files.map(async (f) => {
        if (f.name) return f;
        const ts = now.toISOString().replace(/[:.]/g,'-');
        const ext = (f.type && f.type.split('/')[1]) ? f.type.split('/')[1] : 'png';
        return blobToFile(f, `screenshot-${ts}-${idx++}.${ext}`);
      }));
      addFiles(named);
      status('Добавлено из буфера: ' + named.length);
      await sleep(1000); status('');
    });

    // ===== Firebase
    let _db, _fsMod;
    async function ensureFirebase(){
      if (_db) return;
      const appMod  = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js");
      const authMod = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js");
      const fsMod   = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js");
      const app = appMod.initializeApp(FIREBASE_CONFIG);
      _fsMod = fsMod; _db = fsMod.getFirestore(app);
      try { await authMod.signInAnonymously(authMod.getAuth(app)); } catch {}
    }

    // ===== Пользователи / исполнители
    let usersAll = []; const selectedIds = new Set(); const selectedNames = new Set();
    function renderWorkers(){
      const box = $('#workers'); box.innerHTML = '';
      const workers = usersAll.filter(u => (u.role||'').toLowerCase() === 'кладовщик');
      (workers.length ? workers : usersAll).forEach(u => {
        const b = document.createElement('button'); b.type='button'; b.className='chip'; b.textContent = u.name || u.id;
        let active = false; const set=a=>{active=a; b.classList.toggle('active',a);};
        b.onclick = ()=>{ active? (selectedIds.delete(u.id),selectedNames.delete(u.name||u.id)) : (selectedIds.add(u.id),selectedNames.add(u.name||u.id)); set(!active); };
        box.appendChild(b);
      });
    }
    async function loadUsers(){
      try {
        await ensureFirebase();
        const snap = await _fsMod.getDocs(_fsMod.collection(_db, 'users'));
        usersAll = snap.docs.map(d => ({ id:d.id, name:d.get('name')||d.get('displayName')||d.id, role:(d.get('role')||'').toString() }));
        renderWorkers();
      } catch { $('#workers').innerHTML = '<div class="muted">Не удалось загрузить пользователей</div>'; }
    }

    // ===== Cloudinary (имя .pdf → raw/upload и type="pdf"; unsigned без use/unique_filename)
    async function uploadToCloudinary(file, taskId){
      const isPdf = isPdfByName(file);
      const endpoint = isPdf ? 'raw' : 'auto';
      const form = new FormData();
      form.append('file', file);
      form.append('upload_preset', CONFIG.cloudinary.uploadPreset);
      form.append('folder', `tasks/${taskId}`);

      const resp = await fetch(`https://api.cloudinary.com/v1_1/${CONFIG.cloudinary.cloudName}/${endpoint}/upload`, { method:'POST', body: form });
      let j;
      if (!resp.ok){ try{ j=await resp.json(); }catch{}; throw new Error(j?.error?.message || `Cloudinary upload failed: ${resp.status}`); }
      j = await resp.json();

      const url = (isPdf && typeof j.secure_url === 'string' && j.secure_url.includes('/image/upload/'))
        ? j.secure_url.replace('/image/upload/', '/raw/upload/')
        : j.secure_url;

      return { url, publicId: j.public_id, type: isPdf ? 'pdf' : 'image', name: file.name || 'file' };
    }
    async function uploadAll(taskId){
      const out = []; let i = 0;
      for (const f of filesAll){ i++; status(`Загрузка файлов ${i}/${filesAll.length}…`); out.push(await uploadToCloudinary(f, taskId)); }
      return out;
    }

    // ===== Уведомление (как в приложении)
    async function notifyTaskCreated(taskId, assigneeIds){
      const body = new URLSearchParams();
      body.set('taskId', taskId);
      if (assigneeIds?.length) body.set('assigneeIds', assigneeIds.join(','));
      try {
        await fetch(CONFIG.notifyUrl, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
      } catch {
        const qs = new URLSearchParams({ taskId, assigneeIds:(assigneeIds||[]).join(',') }).toString();
        new Image().src = `${CONFIG.notifyUrl}?${qs}`;
      }
    }

    // ===== Создание задач (записываем строго нужные поля и ничего лишнего)
    function updateCreateDisabled(){ $('#btnCreate').disabled = !(filesAll.length && $('#title').value.trim()); }
    $('#title').addEventListener('input', updateCreateDisabled);

    async function createOneTaskFor(assigneeId, isPickup){
      const docRef = _fsMod.doc(_fsMod.collection(_db, 'tasks'));
      const taskId = docRef.id;

      const data = {
        title: $('#title').value.trim(),
        comment: $('#comment').value.trim(),
        assignees: assigneeId ? [assigneeId] : [],
        isPickup: !!isPickup,
        status: "assigned",
        createdAt: _fsMod.serverTimestamp(),
        creatorId: "unknown",
        creatorName: "unknown",
        files: []
      };
      await _fsMod.setDoc(docRef, data);

      const filesRecs = await uploadAll(taskId);
      await _fsMod.updateDoc(docRef, { files: filesRecs });

      await notifyTaskCreated(taskId, assigneeId ? [assigneeId] : []);
      return taskId;
    }

    async function onCreate(){
      try {
        if (!filesAll.length) { alert('Добавь файлы'); return; }
        const title = $('#title').value.trim();
        if (!title) { alert('Введи заголовок'); return; }

        $('#btnCreate').disabled = true;
        await ensureFirebase();

        const ids = Array.from(selectedIds);
        const created = [];
        status('Создаю задачу(и)…');

        if (!ids.length){
          created.push(await createOneTaskFor(null, true));
        } else {
          for (const id of ids) created.push(await createOneTaskFor(id, false));
        }

        status(`Готово. Создано задач: ${created.length}`);
        alert(`Создано задач: ${created.length}`);

        clearAll(); $('#title').value=''; $('#comment').value='';
        selectedIds.clear(); selectedNames.clear(); $$('#workers .chip').forEach(el=>el.classList.remove('active'));
        updateCreateDisabled();
      } catch (e) {
        console.error(e); alert('Ошибка: ' + (e?.message || e)); status('Ошибка'); $('#btnCreate').disabled = false;
      }
    }
    $('#btnCreate').addEventListener('click', onCreate);

    (async function init(){
      await ensureFirebase(); await loadUsers(); updateCreateDisabled();
      status('Подсказка: Ctrl+V — вставка скриншота.'); setTimeout(()=>status(''), 3000);
    })();
  </script>
</body>
</html>

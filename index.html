<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É ‚Äî –°–∫–ª–∞–¥–°–±–æ—Ä–∫–∞</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{--brand:#FF3B30;--stroke:rgba(0,0,0,.08)}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:Inter,system-ui;background:#f7f7f8;color:#111}
    .wrap{max-width:760px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--stroke);border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.06);padding:20px}
    h1{font-size:22px;margin:0 0 16px;font-weight:800}
    label{display:block;font-size:13px;font-weight:600;margin:14px 0 6px}
    input[type="text"], textarea, .pill{
      width:100%;padding:12px 14px;border:1px solid var(--stroke);border-radius:12px;font:inherit;background:#fff
    }
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .files{padding:12px;border:1px dashed #ccc;border-radius:12px;background:#fafafa}
    .files.drag{background:#eef7ff;border-color:#8ab6ff}
    .file-list{margin:8px 0 0;padding:0;list-style:none;font-size:14px}
    .file-list li{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #eee}
    .file-list small{opacity:.7}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;border-radius:12px;border:1px solid var(--stroke);background:#111;color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:#fff;color:#111}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .hint{font-size:12px;opacity:.7}
    .ok{color:#0a8f3c}.err{color:#c62828}
    .pill{display:flex;gap:8px;flex-wrap:wrap;min-height:46px}
    .chip{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;background:#f0f3f6;border:1px solid #d9e1ea}
    .chip b{font-weight:600}.chip button{border:0;background:none;cursor:pointer;font-size:16px;line-height:1}
    .grid{display:grid;grid-template-columns:1fr 240px;gap:16px}
    .right{position:sticky;top:16px;height:fit-content}
    .danger{background:linear-gradient(180deg, rgba(255,59,48,.06), transparent), #111}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</h1>

    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
    <input id="title" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞–∫–∞–∑ ‚Ññ1234">

    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
    <textarea id="comment" placeholder="–°—Å—ã–ª–∫–∏, —É—Ç–æ—á–Ω–µ–Ω–∏—è, –ø—Ä–∏–º–µ—á–∞–Ω–∏—è‚Ä¶"></textarea>

    <div class="grid" style="margin-top:12px">
      <div>
        <label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <div id="assignees" class="pill" aria-label="–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏"></div>
        <div class="toolbar" style="margin-top:10px">
          <button id="pickUsers" class="btn secondary">–í—ã–±—Ä–∞—Ç—å –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π</button>
          <button id="clearUsers" class="btn secondary">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <label style="margin-top:18px">–§–∞–π–ª—ã (PDF/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)</label>
        <div id="drop" class="files" tabindex="0">
          –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏ <label for="file" style="display:inline;color:#0b57d0;cursor:pointer;text-decoration:underline;margin:0">–≤—ã–±–µ—Ä–∏—Ç–µ</label>.
          <input id="file" type="file" multiple accept="image/*,.pdf" style="display:none">
          <ul id="list" class="file-list"></ul>
          <div class="hint">PDF —É–π–¥—É—Ç –∫–∞–∫ <b>raw</b> –≤ Cloudinary, –æ—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî –∫–∞–∫ <b>image</b>. –ü–∞–ø–∫–∞: <code>tasks/&lt;taskId&gt;</code></div>
        </div>

      </div>
      <div class="right">
        <div class="toolbar">
          <button id="save" class="btn danger">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É</button>
          <button id="logout" class="btn secondary">–í—ã–π—Ç–∏</button>
        </div>
        <div id="status" class="hint" style="margin-top:10px"></div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase (SDK v9 modular) -->
<script type="module">
  // ==== üîß –í–°–¢–ê–í–¨ –°–í–û–ò –î–ê–ù–ù–´–ï –¢–£–¢ ====
  const FIREBASE_CONFIG = {
  apiKey: "AIzaSyC_139FN0Bafm3nym_WTqtwJhJnfDyIRf4",
  authDomain: "skladsborka-6c2a7.firebaseapp.com",
  projectId: "skladsborka-6c2a7",
  storageBucket: "skladsborka-6c2a7.firebasestorage.app",
  appId: "1:516526717198:web:ea995cb4e4123481757f5f"
};
  const CLOUDINARY = {
    cloudName: "dnx1taqp7",      // üîß –Ω–∞–ø—Ä–∏–º–µ—Ä: skladsborka
    uploadPreset: "unsigned_tasks",     // üîß –∫–∞–∫ –≤ Android
    folderPrefix: "tasks"               // üîß –ø–∞–ø–∫–∞
  };
  const NOTIFY_ENDPOINT = "https://skladsborka-notify.vercel.app/api/notify-taskCreated"; // üîß

  // ===== Firebase init =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import { getFirestore, collection, doc, addDoc, setDoc, updateDoc, serverTimestamp, getDocs, query } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  const app = initializeApp(FIREBASE_CONFIG);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ====== UI refs ======
  const $ = (id)=>document.getElementById(id);
  const titleEl = $("title");
  const commentEl = $("comment");
  const dropEl = $("drop");
  const fileEl = $("file");
  const listEl = $("list");
  const pickUsersBtn = $("pickUsers");
  const clearUsersBtn = $("clearUsers");
  const assigneesBox = $("assignees");
  const saveBtn = $("save");
  const statusEl = $("status");
  const logoutBtn = $("logout");

  const selected = { files: [], assignees: [], assigneeNames: [] };

  // ===== Auth (Google popup –ø–æ-–±—ã—Å—Ç—Ä–æ–º—É) =====
  onAuthStateChanged(auth, (user)=>{
    if(!user){
      status("–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥‚Ä¶ –û—Ç–∫—Ä–æ–µ—Ç—Å—è –æ–∫–Ω–æ Google Sign-In");
      signInWithPopup(auth, new GoogleAuthProvider()).catch(e=>{
        statusErr("–í—Ö–æ–¥ –æ—Ç–º–µ–Ω—ë–Ω: "+e.message);
      });
    } else {
      statusOk("–í–æ—à–ª–∏ –∫–∞–∫: "+(user.displayName||user.email));
    }
  });
  logoutBtn.onclick = ()=>signOut(auth);

  // ===== Users picker (–ø—Ä–æ—Å—Ç–∞—è –º–æ–¥–∞–ª–∫–∞) =====
  pickUsersBtn.onclick = async ()=>{
    try{
      const snap = await getDocs(query(collection(db,"users")));
      const items = [];
      snap.forEach(d=>{
        const id = d.id;
        const name = d.get("name") || d.get("displayName") || id;
        items.push({id, name});
      });
      items.sort((a,b)=>a.name.localeCompare(b.name,'ru'));
      const pick = await showPicker(items, selected.assignees);
      if(!pick) return;
      selected.assignees = pick.map(p=>p.id);
      selected.assigneeNames = pick.map(p=>p.name);
      renderAssignees();
    }catch(e){ statusErr("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: "+e.message); }
  };
  clearUsersBtn.onclick = ()=>{ selected.assignees=[]; selected.assigneeNames=[]; renderAssignees(); };

  function renderAssignees(){
    assigneesBox.innerHTML = "";
    if (selected.assignees.length===0){
      assigneesBox.innerHTML = '<span class="hint">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã ‚Äî –∑–∞–¥–∞–Ω–∏–µ —É–π–¥—ë—Ç –∫–∞–∫ <b>—Å–∞–º–æ–≤—ã–≤–æ–∑</b> –¥–ª—è –≤—Å–µ—Ö</span>';
      return;
    }
    selected.assigneeNames.forEach((n,i)=>{
      const chip = document.createElement("span");
      chip.className="chip";
      chip.innerHTML = `<b>${escapeHtml(n)}</b> <button title="–£–±—Ä–∞—Ç—å" aria-label="–£–±—Ä–∞—Ç—å">&times;</button>`;
      chip.querySelector("button").onclick = ()=>{ selected.assignees.splice(i,1); selected.assigneeNames.splice(i,1); renderAssignees(); };
      assigneesBox.appendChild(chip);
    });
  }

  // ===== Files (drop/choose) =====
  fileEl.onchange = ()=>addFiles([...fileEl.files]);
  ["dragenter","dragover"].forEach(ev => dropEl.addEventListener(ev, e=>{ e.preventDefault(); dropEl.classList.add("drag"); }));
  ["dragleave","drop"].forEach(ev => dropEl.addEventListener(ev, e=>{ e.preventDefault(); dropEl.classList.remove("drag"); }));
  dropEl.addEventListener("drop", e=>addFiles([...e.dataTransfer.files]));

  function addFiles(files){
    for(const f of files){
      if(!f || !f.name) continue;
      if (selected.files.find(x=>x.name===f.name && x.size===f.size)) continue;
      selected.files.push(f);
    }
    renderFiles();
  }
  function renderFiles(){
    listEl.innerHTML="";
    selected.files.forEach((f, i)=>{
      const li = document.createElement("li");
      li.innerHTML = `<b>${escapeHtml(f.name)}</b> <small>${(f.size/1024/1024).toFixed(2)} MB</small>
        <button aria-label="–£–¥–∞–ª–∏—Ç—å" style="margin-left:auto" class="btn secondary">–£–¥–∞–ª–∏—Ç—å</button>`;
      li.querySelector("button").onclick = ()=>{ selected.files.splice(i,1); renderFiles(); };
      listEl.appendChild(li);
    });
  }

  // ===== Save =====
  saveBtn.onclick = async ()=>{
    const user = auth.currentUser;
    if(!user){ return statusErr("–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ö–æ–¥"); }
    const title = titleEl.value.trim();
    const comment = commentEl.value.trim();
    if(!title) return statusErr("–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫");

    saveBtn.disabled = true; status("–°–æ–∑–¥–∞—ë–º –∑–∞–¥–∞—á—É‚Ä¶");
    try{
      // 1) –ß–µ—Ä–Ω–æ–≤–∏–∫ –∑–∞–¥–∞—á–∏
      const taskRef = await addDoc(collection(db,"tasks"), {
        title, comment,
        assignees: selected.assignees,
        assigneeNames: selected.assigneeNames,
        isPickup: selected.assignees.length===0,       // ‚Üê –ª–æ–≥–∏–∫–∞ –∫–∞–∫ –≤ Android
        status: "assigned",
        createdAt: serverTimestamp(),
        creatorId: user.uid || "unknown",
        creatorName: user.displayName || user.email || "unknown",
        files: []
      });

      // 2) –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ (–ø–æ –æ–¥–Ω–æ–º—É, —á—Ç–æ–±—ã –∏–º–µ—Ç—å –ø–æ—Ä—è–¥–æ–∫/–∫–æ–Ω—Ç—Ä–æ–ª—å —Ç–∏–ø–æ–≤)
      const uploaded = [];
      for(let i=0;i<selected.files.length;i++){
        const f = selected.files[i];
        status(`–ó–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤: ${i+1}/${selected.files.length}‚Ä¶`);
        const up = await uploadToCloudinary(f, taskRef.id);
        uploaded.push(up);
      }

      // 3) –û–±–Ω–æ–≤–ª—è–µ–º files –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ
      if (uploaded.length>0){
        await updateDoc(doc(db,"tasks",taskRef.id), { files: uploaded, updatedAt: serverTimestamp() });
      }

      // 4) –î—ë—Ä–≥–∞–µ–º –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä (—Å–µ—Ä–≤–µ—Ä —Å–∞–º —Ä–µ—à–∏—Ç ‚Äî –ø—É—à –≤—Å–µ–º/–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è–º)
      try{
        await fetch(NOTIFY_ENDPOINT, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({taskId: taskRef.id})});
      }catch(_){/* –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ–º UX */}

      statusOk("–ì–æ—Ç–æ–≤–æ: –∑–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞");
      titleEl.value=""; commentEl.value=""; selected.files=[]; renderFiles();
      // (–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –æ—Å—Ç–∞–≤–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ ‚Äî —Ç–∞–∫ —É–¥–æ–±–Ω–µ–µ –ø–∞—á–∫–æ–π —Å–æ–∑–¥–∞–≤–∞—Ç—å)
    }catch(e){
      statusErr("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: "+e.message);
    }finally{
      saveBtn.disabled = false;
    }
  };

  // ===== Cloudinary (unsigned) =====
  async function uploadToCloudinary(file, taskId){
    const name = file.name || "file";
    const isPdf = /\.pdf$/i.test(name);
    const resource = isPdf ? "raw" : "auto"; // raw –¥–ª—è PDF ‚Äî –∫—Ä–∏—Ç–∏—á–Ω–æ
    const url = `https://api.cloudinary.com/v1_1/${encodeURIComponent(CLOUDINARY.cloudName)}/${resource}/upload`;
    const fd = new FormData();
    fd.append("file", file);
    fd.append("upload_preset", CLOUDINARY.uploadPreset);
    fd.append("folder", `${CLOUDINARY.folderPrefix}/${taskId}`);
    // –ú–æ–∂–Ω–æ –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å —Ç–∏–ø:
    if (isPdf) fd.append("resource_type", "raw");

    const res = await fetch(url, { method:"POST", body: fd });
    if (!res.ok) throw new Error("Upload failed: "+res.status);
    const j = await res.json();
    // –æ–∂–∏–¥–∞–µ–º secure_url, public_id, resource_type
    let fileType = j.resource_type || (isPdf ? "raw" : "image");
    // –∏–Ω–æ–≥–¥–∞ PDF —É—Ö–æ–¥–∏—Ç –∫–∞–∫ image ‚Äî –ø–æ—á–∏–Ω–∏–º —Ç–∏–ø –¥–ª—è downstream
    if (isPdf && fileType!=="raw") fileType = "pdf";

    return {
      url: j.secure_url,
      publicId: j.public_id,
      type: fileType,
      name
    };
  }

  // ===== —É—Ç–∏–ª–∏—Ç—ã =====
  function status(t){ statusEl.innerHTML = t; statusEl.className="hint"; }
  function statusOk(t){ statusEl.innerHTML = `<span class="ok">${t}</span>`; statusEl.className="hint"; }
  function statusErr(t){ statusEl.innerHTML = `<span class="err">${t}</span>`; statusEl.className="hint"; }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

  // –ü—Ä–æ—Å—Ç–µ–Ω—å–∫–∏–π –ø–∏–∫–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  function showPicker(items, preselected){
    return new Promise(resolve=>{
      const sel = new Set(preselected||[]);
      const dlg = document.createElement("dialog");
      dlg.style.padding="0"; dlg.style.border="none"; dlg.style.borderRadius="14px"; dlg.style.width="min(680px, 96vw)";
      dlg.innerHTML = `
        <form method="dialog" style="padding:16px 16px 10px">
          <h3 style="margin:4px 0 12px;font-weight:800">–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π</h3>
          <input id="filt" type="text" placeholder="–§–∏–ª—å—Ç—Ä‚Ä¶" style="width:100%;padding:10px 12px;border:1px solid var(--stroke);border-radius:10px">
          <div id="lst" style="margin-top:10px;max-height:52vh;overflow:auto;border:1px solid #eee;border-radius:10px;padding:8px;background:#fafafa"></div>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
            <button value="cancel" class="btn secondary">–û—Ç–º–µ–Ω–∞</button>
            <button id="ok" value="ok" class="btn">–í—ã–±—Ä–∞—Ç—å</button>
          </div>
        </form>`;
      document.body.appendChild(dlg);

      const lst = dlg.querySelector("#lst");
      const filt = dlg.querySelector("#filt");
      function renderList(){
        const q = (filt.value||"").toLowerCase();
        lst.innerHTML = "";
        items.forEach(it=>{
          if (q && !it.name.toLowerCase().includes(q) && !it.id.toLowerCase().includes(q)) return;
          const row = document.createElement("label");
          row.style.cssText = "display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid #eee;cursor:pointer";
          row.innerHTML = `<input type="checkbox" ${sel.has(it.id)?"checked":""}> <div><b>${escapeHtml(it.name)}</b><div class="hint">${escapeHtml(it.id)}</div></div>`;
          row.querySelector("input").onchange = (e)=>{ if(e.target.checked) sel.add(it.id); else sel.delete(it.id); };
          lst.appendChild(row);
        });
      }
      renderList();
      filt.oninput = renderList;

      dlg.addEventListener("close", ()=>{
        if (dlg.returnValue!=="ok"){ dlg.remove(); return resolve(null); }
        const res = items.filter(it=>sel.has(it.id));
        dlg.remove(); resolve(res);
      });
      dlg.showModal();
    });
  }
</script>
</body>
</html>

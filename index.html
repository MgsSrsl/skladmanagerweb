<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É ‚Äî –°–∫–ª–∞–¥–°–±–æ—Ä–∫–∞ (XLSX auto-header)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #0b0f14; color: #fff; }
    .container { max-width: 1100px; margin: 24px auto 64px; padding: 0 16px; }
    h1 { margin: 0 0 16px; font-weight: 700; }
    .card { background:#0d1422; border:1px solid #1f2a44; border-radius:14px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .row > * { flex:1 1 auto }
    .dropzone { border: 2px dashed #4b5563; border-radius: 14px; padding: 22px; background: #111827; text-align: center; transition: .2s; }
    .dropzone.drag { background: #1f2937; border-color: #60a5fa; }
    label { font-size: 14px; color: #9ca3af; display:block; margin: 12px 0 6px;}
    input[type="text"], textarea {
      width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid #374151; background: #0b1220; color: #fff;
    }
    textarea { min-height: 80px; resize: vertical; }
    button { background: #3b82f6; border: 0; color: #fff; padding: 10px 14px; border-radius: 10px; cursor: pointer; font-weight: 600; }
    button.ghost { background:#0b1220; border:1px solid #374151; }
    button[disabled] { opacity:.6; cursor: not-allowed }
    .status { margin-top: 8px; font-size: 14px; color: #93c5fd; white-space: pre-wrap; }
    .files { margin-top: 10px; }
    .fileRow { display:flex; align-items:center; gap:8px; margin:6px 0; padding:8px; border:1px solid #1f2a44; border-radius:10px; background:#0b1220; }
    .fileRow .name { flex:1 1 auto; }
    .fileRow .size { font-size:12px; opacity:.75 }
    table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border: 1px solid #374151; padding: 6px 8px; vertical-align: top; }
    th { background: #111827; color: #cbd5e1; position: sticky; top: 0; }
    tr td input, tr td select { width: 100%; border:0; outline: none; background: transparent; color: #fff; }
    tr.lowconf td { background: #382e00; }
    .totals { display:flex; justify-content: space-between; align-items:center; gap:10px; margin-top: 6px; color:#cbd5e1 }
    .kbd { background:#111827; border:1px solid #374151; border-radius:6px; padding:0 6px; }
    .muted { color:#9ca3af; font-size:13px }
    .chip { border:1px solid #374151; background:#0b1220; padding:8px 10px; border-radius:999px; cursor:pointer; }
    .chip.active { background:#1e293b; border-color:#60a5fa; }
    .hidden { display:none !important; }
    #fileInput { position: fixed; left: -9999px; top: -9999px; width: 1px; height: 1px; opacity: 0; }
  </style>
  <!-- SheetJS –¥–ª—è XLSX/CSV -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É (XLSX/CSV, –∞–≤—Ç–æ-–ø–æ–∏—Å–∫ —à–∞–ø–∫–∏)</h1>

    <div class="card">
      <div class="dropzone" id="drop">
        <p><b>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ XLSX/XLS/CSV (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)</b> –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã¬ª.<br>
        –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –∑–∞–≥–æ–ª–æ–≤–∫–∏ (—Å–∏–Ω–æ–Ω–∏–º—ã): <span class="kbd">No/‚Ññ/–ù–æ–º–µ—Ä/#</span>, <span class="kbd">Article/–ê—Ä—Ç–∏–∫—É–ª/SKU/–ö–æ–¥</span>, <span class="kbd">Title/–¢–æ–≤–∞—Ä/–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</span>, <span class="kbd">Qty/–ö–æ–ª-–≤–æ/–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</span>, <span class="kbd">Unit/–ï–¥.</span>, <span class="kbd">QtyPacks/–£–ø–∞–∫–æ–≤–æ–∫</span>, <span class="kbd">QtyUnits/–®—Ç</span>.<br>
        <small>–®–∞–ø–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å <u>–Ω–µ</u> –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ ‚Äî –Ω–∞–π–¥—ë–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</small></p>
        <div class="row" style="justify-content:center">
          <button id="btnPick" type="button" class="ghost">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</button>
          <button id="btnClearFiles" type="button" class="ghost">–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
          <button id="btnReparse" type="button" class="ghost">–ü–µ—Ä–µ–ø–∞—Ä—Å–∏—Ç—å</button>
        </div>
        <input id="fileInput" type="file" multiple accept=".xlsx,.xls,.csv" />
        <div id="filesList" class="files"></div>
        <div id="status" class="status"></div>
      </div>
    </div>

    <div class="card">
      <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
      <input id="title" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Ç–≥—Ä—É–∑–∫–∞ #1234" />
      <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
      <textarea id="comment" placeholder="–°–∫–ª–∞–¥, –∑–∞–∫–∞–∑ ‚Ññ, –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç ‚Äî –º–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Å—é–¥–∞"></textarea>
    </div>

    <div class="card">
      <label>–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ (–∫–ª–∞–¥–æ–≤—â–∏–∫–∏)</label>
      <div id="workersBox" class="row" style="gap:8px"></div>
      <div class="muted">–ï—Å–ª–∏ –Ω–∏–∫–æ–≥–æ –Ω–µ –≤—ã–±—Ä–∞—Ç—å ‚Äî –±—É–¥–µ—Ç —Å–∞–º–æ–≤—ã–≤–æ–∑ (–æ–¥–Ω–∞ –∑–∞–¥–∞—á–∞ –±–µ–∑ assignees).</div>
    </div>

    <div class="card">
      <div class="row" style="align-items:center">
        <div style="flex:2"><label>–ü–æ–∑–∏—Ü–∏–∏</label></div>
        <div style="flex:1; text-align:right">
          <label style="display:inline-flex; gap:8px; align-items:center">
            <input id="mergeToggle" type="checkbox" />
            <span class="muted">–°–∫–ª–µ–∏–≤–∞—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏</span>
          </label>
        </div>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:56px">#</th>
            <th>–¢–æ–≤–∞—Ä</th>
            <th style="max-width:220px">–ê—Ä—Ç–∏–∫—É–ª</th>
            <th style="width:110px">–ö–æ–ª-–≤–æ</th>
            <th style="width:110px">–ï–¥.</th>
            <th style="width:110px">–£–ø–∞–∫–æ–≤–æ–∫</th>
            <th style="width:110px">–®—Ç</th>
            <th style="width:40px"></th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
      <div class="totals">
        <div id="sourcesInfo" class="muted"></div>
        <div id="totals"></div>
      </div>
    </div>

    <div class="card" style="display:flex;gap:10px;justify-content:flex-end">
      <button id="btnCreate" type="button" disabled>–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>
    </div>
  </div>

  <script>
    // ====== –£—Ç–∏–ª–∏—Ç—ã ======
    const $ = s => document.querySelector(s);
    const status = t => { $('#status').textContent = t || ''; };
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));
    const readAsArrayBuffer = (f)=> new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsArrayBuffer(f); });
    const readAsText = (f, enc='utf-8')=> new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsText(f, enc); });

    // ====== –ö–æ–Ω—Ñ–∏–≥ ======
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyAH58ZpWAp64mhM589KD6jXHcOlPqU0aYU",
      authDomain: "skladsborka-6c2a7.firebaseapp.com",
      projectId: "skladsborka-6c2a7",
      storageBucket: "skladsborka-6c2a7.appspot.com",
      messagingSenderId: "516526717198"
    };
    const CLOUDINARY_CLOUD_NAME    = "dnx1taqp7";
    const CLOUDINARY_UPLOAD_PRESET = "unsigned_tasks";
    const VERCEL_NOTIFY_PROXY_URL  = "/api/notify-taskCreated";

    // ====== –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è ======
    const UNIT_ALIASES = {
      // –±–∞–∑–æ–≤—ã–µ
      "—à—Ç":"—à—Ç","—à—Ç—É–∫":"—à—Ç","—à—Ç—É–∫–∞":"—à—Ç","—à—Ç—É–∫–∏":"—à—Ç","—à—Ç.":"—à—Ç",
      "–ª–∏—Å—Ç":"–ª–∏—Å—Ç","–ª–∏—Å—Ç–∞":"–ª–∏—Å—Ç","–ª–∏—Å—Ç—ã":"–ª–∏—Å—Ç",
      "—É–ø–∞–∫":"—É–ø–∞–∫","—É–ø–∞–∫–æ–≤–∫–∞":"—É–ø–∞–∫","—É–ø–∞–∫–æ–≤–∫–∏":"—É–ø–∞–∫","—É–ø–∞–∫–æ–≤–æ–∫":"—É–ø–∞–∫","–ø–∞–∫":"—É–ø–∞–∫","–ø–∞—á":"—É–ø–∞–∫",
      // —Ä—É–ª–æ–Ω—ã, –∫–æ—Ä–æ–±–∫–∏, –∫–æ–º–ø–ª–µ–∫—Ç—ã
      "—Ä—É–ª":"—Ä—É–ª","—Ä—É–ª–æ–Ω":"—Ä—É–ª","—Ä—É–ª.":"—Ä—É–ª",
      "–∫–æ—Ä":"–∫–æ—Ä","–∫–æ—Ä–æ–±":"–∫–æ—Ä","–∫–æ—Ä–æ–±–∫–∞":"–∫–æ—Ä","–∫–æ—Ä–æ–±–æ–∫":"–∫–æ—Ä",
      "–∫–æ–º–ø":"–∫–æ–º–ø–ª","–∫–æ–º–ø–ª":"–∫–æ–º–ø–ª","–∫–æ–º–ø–ª–µ–∫—Ç":"–∫–æ–º–ø–ª",
      "–ø–∞—Ä":"–ø–∞—Ä–∞","–ø–∞—Ä–∞":"–ø–∞—Ä–∞","–ø–∞—Ä—ã":"–ø–∞—Ä–∞",
      // –º–µ—Ç—Ä—ã
      "–º":"–º","–º–µ—Ç—Ä":"–º","–º.–ø.":"–º.–ø","–º.–ø":"–º.–ø","–ø–æ–≥.–º":"–º.–ø","–ø–æ–≥–æ–Ω–Ω—ã–π –º–µ—Ç—Ä":"–º.–ø",
      "–º2":"–º¬≤","–º^2":"–º¬≤","m2":"–º¬≤","–º¬≤":"–º¬≤",
      // –≤–µ—Å, –æ–±—ä—ë–º
      "–∫–≥":"–∫–≥","–∫–∏–ª–æ–≥—Ä–∞–º–º":"–∫–≥","–≥":"–≥","–≥—Ä":"–≥","–≥—Ä–∞–º–º":"–≥","–ª":"–ª","–ª–∏—Ç—Ä":"–ª","–ª–∏—Ç—Ä–∞":"–ª","–ª–∏—Ç—Ä–æ–≤":"–ª"
    };
    const normUnit = (u)=> UNIT_ALIASES[(u??"").toString().trim().toLowerCase()] || (u??"").toString().trim().toLowerCase();

    // üîπ –£–º–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —á–∏—Å–µ–ª
    const normNum = (s) => {
      if (s == null) return "";
      s = s.toString().trim()
           .replace(/\u00A0/g, ' ')  // –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
           .replace(/\s+/g, ' ');
      // "1.234.567,89" ‚Üí "1234567.89"
      if (/^\d{1,3}(\.\d{3})+(,\d+)?$/.test(s)) return s.replace(/\./g, '').replace(',', '.');
      // "1 234 567,89" –∏–ª–∏ "1 234 567.89" ‚Üí "1234567.89"
      if (/^\d{1,3}( \d{3})+([.,]\d+)?$/.test(s)) return s.replace(/ /g, '').replace(',', '.');
      // "1.000" ‚Üí "1000"
      if (/^\d+\.\d{3}$/.test(s)) return s.replace(/\./g, '');
      // "1,000" ‚Üí "1000"
      if (/^\d+,\d{3}$/.test(s)) return s.replace(/,/g, '');
      // –æ–±—ã—á–Ω—ã–π —Å–ª—É—á–∞–π
      return s.replace(',', '.');
    };
    const toNum = (s)=> { const n = parseFloat(normNum(s)); return Number.isFinite(n) ? n : 0; };

    // üîπ –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é ‚Üí –µ–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è
    const TITLE_UNIT_HINTS = [
      { re: /\b(–ª–∏—Å—Ç|–ª–∏—Å—Ç—ã|–ø–ª–∏—Ç–∞|–ø–ª–∏—Ç—ã|–ø–∞–Ω–µ–ª[—å—è–∏]|–ø–∞–Ω–µ–ª—å|osb|–≥–∫–ª|–≥–≤–ª|—Ü—Å–ø|—Ñ–∞–Ω–µ—Ä–∞|–ø—Ä–æ—Ñ–ª–∏—Å—Ç)\b/i, unit: "–ª–∏—Å—Ç" },
      { re: /\b(—Ä—É–ª–æ–Ω|—Ä—É–ª\.?|—Ä—É–ª)\b/i, unit: "—Ä—É–ª" },
      { re: /\b(—Å–∞–º–æ—Ä–µ–∑|—à—É—Ä—É–ø|–¥—é–±–µ–ª|–∫–ª–∏–ø—Å|–∫–ª—è–π–º–µ—Ä|–≥–≤–æ–∑–¥|—à—É—Ä—É–ø—ã|–∫—Ä–µ–ø–µ–∂)\b/i, unit: "—à—Ç" },
      { re: /\b(–∫—Ä–∞—Å–∫–∞|—ç–º–∞–ª—å|–ø—Ä–∞–π–º–µ—Ä|–≥—Ä—É–Ω—Ç–æ–≤|–ª–∞–∫)\b/i, unit: "–ª" },
      { re: /\b(–ø–µ–Ω–∞|–∫–ª–µ–π|—à–ø–∞—Ç–ª–µ–≤|—à–ø–∞–∫–ª|–≥–µ—Ä–º–µ—Ç)\b/i, unit: "–∫–≥" },
      { re: /\b(—Ç—Ä—É–±–∞|–ø—Ä–æ—Ñ–∏–ª—å|—É–≥–æ–ª–æ–∫|–ø–ª–∞–Ω–∫–∞|–¥–æ–±–æ—Ä|–∫–∞–Ω–∞–ª|—Ä–µ–π–∫–∞|–Ω–∞–ª–∏—á–Ω–∏–∫)\b/i, unit: "–º.–ø" }
    ];
    function guessUnitFromText(title, article) {
      const t = (title||"") + " " + (article||"");
      for (const h of TITLE_UNIT_HINTS) { if (h.re.test(t)) return h.unit; }
      return null;
    }

    // ====== DnD / —Ñ–∞–π–ª—ã ======
    const drop = $('#drop');
    const fi   = $('#fileInput');
    $('#btnPick').addEventListener('click', () => fi.click());
    $('#btnClearFiles').addEventListener('click', clearFiles);
    $('#btnReparse').addEventListener('click', reparseAll);
    ['dragenter','dragover'].forEach(ev=>{
      document.addEventListener(ev, e=>{ e.preventDefault(); });
      drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); });
    });
    ['dragleave','drop'].forEach(ev=>{
      document.addEventListener(ev, e=>{ e.preventDefault(); });
      drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); });
    });
    drop.addEventListener('drop', e => { handleFiles(e.dataTransfer.files); });
    fi.addEventListener('change', () => handleFiles(fi.files));

    let filesAll = [];        // –∏—Å—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã
    let itemsParsedRaw = [];  // —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏
    let itemsRendered = [];

    function clearFiles(){
      filesAll = [];
      itemsParsedRaw = [];
      itemsRendered = [];
      $('#filesList').innerHTML = "";
      $('#itemsBody').innerHTML = "";
      $('#totals').textContent = "";
      $('#sourcesInfo').textContent = "";
      status('');
      updateCreateDisabled();
    }
    function renderFilesList() {
      const box = $('#filesList'); box.innerHTML = "";
      if (!filesAll.length) return;
      let idx=0;
      for (const f of filesAll) {
        const row = document.createElement('div');
        row.className = 'fileRow';
        const name = document.createElement('div'); name.className='name'; name.textContent = f.name;
        const size = document.createElement('div'); size.className='size'; size.textContent = (f.size/1024/1024).toFixed(2)+' MB';
        const btnDel = document.createElement('button'); btnDel.type='button'; btnDel.className='ghost'; btnDel.textContent='–£–¥–∞–ª–∏—Ç—å';
        const btnRe = document.createElement('button'); btnRe.type='button'; btnRe.className='ghost'; btnRe.textContent='–†–∞—Å–ø–∞—Ä—Å–∏—Ç—å —ç—Ç–æ—Ç';
        const thisIndex = idx++;
        btnDel.onclick = async () => { filesAll.splice(thisIndex,1); await reparseAll(); };
        btnRe.onclick = async () => { await parseOneFileIntoRaw(f, true); rerenderFromRaw(); };
        row.appendChild(name); row.appendChild(size); row.appendChild(btnRe); row.appendChild(btnDel);
        box.appendChild(row);
      }
    }
    async function handleFiles(fileList){
      const arr = Array.from(fileList || []).filter(Boolean);
      if (!arr.length) return;
      filesAll.push(...arr);
      renderFilesList();
      await reparseAll();
    }

    // ====== XLSX/CSV ‚Üí items (–∞–≤—Ç–æ-–ø–æ–∏—Å–∫ —à–∞–ø–∫–∏ –≤ –ª—é–±–æ–π —Å—Ç—Ä–æ–∫–µ) ======
    const HEADER_MAP = {
      rowNo:    ["no","‚Ññ","#","–Ω–æ–º–µ—Ä","row","rowno"],
      article:  ["article","–∞—Ä—Ç–∏–∫—É–ª","sku","–∫–æ–¥","code"],
      title:    ["title","—Ç–æ–≤–∞—Ä","–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ","–Ω–∞–∑–≤–∞–Ω–∏–µ","item","product","desc","description"],
      qty:      ["qty","–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ","–∫–æ–ª-–≤–æ","amount"],
      unit:     ["unit","–µ–¥.","–µ–¥","–µ–¥–∏–Ω–∏—Ü–∞","uom"],
      qtyPacks: ["qtypacks","—É–ø–∞–∫–æ–≤–æ–∫","packs","pack"],
      qtyUnits: ["qtyunits","—à—Ç","—à—Ç—É–∫","pieces","pcs"]
    };
    function keyOf(colName){
      const s = (colName||"").toString().trim().toLowerCase();
      for (const k of Object.keys(HEADER_MAP)){ if (HEADER_MAP[k].includes(s)) return k; }
      return null;
    }
    function mapColumns(headerRow){
      const map = {};
      headerRow.forEach((h,i)=>{ const k = keyOf(h); if (k && !(k in map)) map[k] = i; });
      return map;
    }
    function findHeaderRow(aoa){
      for (let i=0;i<Math.min(aoa.length, 50);i++){
        const row = aoa[i] || [];
        const cols = mapColumns(row);
        const hasTitle = cols.title != null;
        const count = Object.keys(cols).length;
        if (hasTitle && count >= 2) return { idx:i, cols };
      }
      return { idx:0, cols: mapColumns(aoa[0] || []) };
    }
    function getCell(row, idx){ return (idx==null||idx<0) ? "" : (row[idx] ?? ""); }

    async function parseXlsxFile(file){
      const ab = await readAsArrayBuffer(file);
      const wb = XLSX.read(ab, { type:'array' });
      const sheetName = wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      const aoa = XLSX.utils.sheet_to_json(ws, { header:1, raw:false, defval:"" }); // AOA
      return parseAOA(aoa);
    }
    async function parseCsvFile(file){
      const txt = await readAsText(file, 'utf-8'); // –ø—Ä–∏ –∫—Ä–∞–∫–æ–∑—è–±—Ä–∞—Ö –º–æ–∂–Ω–æ —Å–º–µ–Ω–∏—Ç—å –Ω–∞ windows-1251
      const wb = XLSX.read(txt, {type:'string'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const aoa = XLSX.utils.sheet_to_json(ws, { header:1, raw:false, defval:"" });
      return parseAOA(aoa);
    }
    function parseAOA(aoa){
      if (!aoa.length) return [];
      const { idx:headIdx, cols } = findHeaderRow(aoa);
      const out = [];
      let autoRow = 1;
      for (let r=headIdx+1; r<aoa.length; r++){
        const row = aoa[r] || [];
        const title   = (getCell(row, cols.title)   || "").toString().trim();
        const article = (getCell(row, cols.article) || "").toString().trim();
        const rowNoR  = (getCell(row, cols.rowNo)   || "").toString().trim();
        let qty       = (getCell(row, cols.qty)     || "").toString().trim();
        let unit      = (getCell(row, cols.unit)    || "").toString().trim();
        let qtyPacks  = (getCell(row, cols.qtyPacks)|| "").toString().trim();
        let qtyUnits  = (getCell(row, cols.qtyUnits)|| "").toString().trim();

        if (!title && !qty && !qtyPacks && !qtyUnits) continue;

        // –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è
        unit = normUnit(unit);
        qty = normNum(qty);
        qtyPacks = normNum(qtyPacks);
        qtyUnits = normNum(qtyUnits);

        // –ø–æ–ø—ã—Ç–∫–∞ —É–≥–∞–¥–∞—Ç—å –µ–¥. –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –µ—Å–ª–∏ —è–≤–Ω–æ –Ω–µ –∑–∞–¥–∞–Ω–æ
        const unitGuess = guessUnitFromText(title, article);
        if (!unit && unitGuess) unit = unitGuess;
        if (unit === "—à—Ç" && unitGuess && unitGuess !== "—à—Ç" && !qtyPacks && !qtyUnits) {
          unit = unitGuess;
        }

        // fallback-–ø—Ä–∞–≤–∏–ª–∞
        if (!unit) {
          if (qtyPacks) unit = "—É–ø–∞–∫";
          else if (qtyUnits) unit = "—à—Ç";
        }
        if (!unit && qty) {
          unit = "—à—Ç";
          if (!qtyUnits) qtyUnits = qty;
        }

        // —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ Qty + Unit
        if (qty && unit) {
          if (unit === "—É–ø–∞–∫" && !qtyPacks) qtyPacks = qty;
          if (unit !== "—É–ø–∞–∫" && !qtyUnits) qtyUnits = qty;
        }

        const rowNo = rowNoR || String(autoRow++);
        out.push({ rowNo, title, article, qty, unit, qtyPacks, qtyUnits, _lowconf:false, _src:"" });
      }
      return out;
    }

    async function parseOneFile(file){
      try {
        const lower = file.name.toLowerCase();
        if (/\.(xlsx|xls)$/.test(lower)) {
          status(`–ß–∏—Ç–∞—é XLSX: ${file.name}`);
          const arr = await parseXlsxFile(file);
          arr.forEach(it => it._src = file.name);
          return arr;
        } else if (/\.csv$/.test(lower)) {
          status(`–ß–∏—Ç–∞—é CSV: ${file.name}`);
          const arr = await parseCsvFile(file);
          arr.forEach(it => it._src = file.name);
          return arr;
        } else {
          status(`–ü—Ä–æ–ø—É—Å–∫: –Ω–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞ ${file.name}`);
          return [];
        }
      } catch (e) {
        console.error(e);
        status('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ' + file.name + ': ' + (e?.message||e));
        return [];
      }
    }
    async function parseOneFileIntoRaw(file, replaceRaw = false) {
      const arr = await parseOneFile(file);
      if (replaceRaw) {
        itemsParsedRaw = itemsParsedRaw.filter(x => x._src !== file.name).concat(arr);
      } else {
        itemsParsedRaw.push(...arr);
      }
    }
    async function reparseAll() {
      $('#itemsBody').innerHTML = ""; $('#totals').textContent = ""; $('#sourcesInfo').textContent = "";
      itemsParsedRaw = [];
      if (!filesAll.length) { updateCreateDisabled(); status(''); return; }
      let i=0;
      for (const f of filesAll) {
        i++;
        status(`–ü–∞—Ä—Å–∏–Ω–≥ ${i}/${filesAll.length}: ${f.name}`);
        await parseOneFileIntoRaw(f);
        await sleep(10);
      }
      rerenderFromRaw();
      renderFilesList();
      status(`–ì–æ—Ç–æ–≤–æ. –ù–∞–π–¥–µ–Ω–æ –ø–æ–∑–∏—Ü–∏–π: ${itemsParsedRaw.length} –∏–∑ ${filesAll.length} —Ñ–∞–π–ª(–æ–≤)`);
    }

    // ====== Merge (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) ======
    function mergeSameItemsKeepOrder(items) {
      const map = new Map();
      const order = [];
      for (const it of items) {
        const key = (it.article && it.article.trim())
          ? "A#"+it.article.trim().toUpperCase()
          : "T#"+(it.title||"").trim().toUpperCase();
        if (!map.has(key)) { map.set(key, {...it}); order.push(key); }
        else {
          const m = map.get(key);
          const add = (a,b)=> String((toNum(a)||0)+(toNum(b)||0)||"");
          m.qtyPacks = add(m.qtyPacks, it.qtyPacks);
          m.qtyUnits = add(m.qtyUnits, it.qtyUnits);
          if ((m.unit||"") === (it.unit||"")) { m.qty = add(m.qty, it.qty); }
          m._lowconf = m._lowconf || it._lowconf;
        }
      }
      return order.map(k => map.get(k));
    }

    // ====== –†–µ–Ω–¥–µ—Ä ======
    function renderItems(items) {
      const tbody = $('#itemsBody'); tbody.innerHTML = "";
      for (const it of items) {
        const tr = document.createElement('tr');
        if (it._lowconf) tr.classList.add('lowconf');
        tr.innerHTML = `
          <td><input value="${it.rowNo||""}" data-k="rowNo" style="max-width:56px"></td>
          <td><input value="${it.title||""}"    data-k="title"></td>
          <td><input value="${it.article||""}"  data-k="article" style="max-width:220px"></td>
          <td><input value="${it.qty||it.qtyUnits||""}" data-k="qty" style="max-width:110px"></td>
          <td>
            <select data-k="unit" style="width:100%">
              ${["","—à—Ç","–ª–∏—Å—Ç","—É–ø–∞–∫","—Ä—É–ª","–∫–æ—Ä","–∫–æ–º–ø–ª","–ø–∞—Ä–∞","–º","–º.–ø","–º¬≤","–∫–≥","–≥","–ª"].map(u=>`<option value="${u}" ${(it.unit||"")===u?"selected":""}>${u}</option>`).join("")}
            </select>
          </td>
          <td><input value="${it.qtyPacks||""}" data-k="qtyPacks" placeholder="–µ—Å–ª–∏ –µ—Å—Ç—å" style="max-width:110px"></td>
          <td><input value="${it.qtyUnits||""}" data-k="qtyUnits" placeholder="–µ—Å–ª–∏ –µ—Å—Ç—å" style="max-width:110px"></td>
          <td><button type="button" class="rm">‚úï</button></td>
        `;
        tr.querySelector('.rm').onclick = () => { tr.remove(); updateTotals(); };
        tr.querySelectorAll('input,select').forEach(inp => inp.addEventListener('input', updateTotals));
        tbody.appendChild(tr);
      }
      updateTotals();
    }

    function collectItemsFromTable() {
      return [...document.querySelectorAll('#itemsBody tr')].map(tr => {
        const get = k => (tr.querySelector(`[data-k="${k}"]`)?.value || "").trim();

        const qtyRaw   = get('qty');
        const title    = get('title');
        const article  = get('article');

        let unit      = normUnit(get('unit'));
        let qtyPacks  = get('qtyPacks');
        let qtyUnits  = get('qtyUnits');
        const qty     = normNum(qtyRaw);

        // –ø–æ–ø—ã—Ç–∫–∞ —É–≥–∞–¥–∞—Ç—å –µ–¥. –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
        const unitGuess = guessUnitFromText(title, article);
        if (!unit && unitGuess) unit = unitGuess;
        if (unit === "—à—Ç" && unitGuess && unitGuess !== "—à—Ç" && !qtyPacks && !qtyUnits) {
          unit = unitGuess;
        }

        // –∞–≤—Ç–æ–µ–¥–∏–Ω–∏—Ü–∞, –µ—Å–ª–∏ –≤—Å—ë –µ—â—ë –ø—É—Å—Ç–æ
        if (!unit) {
          if (qtyPacks) unit = "—É–ø–∞–∫";
          else if (qtyUnits) unit = "—à—Ç";
          else if (qty) { unit = "—à—Ç"; qtyUnits = qtyUnits || qty; }
        }

        // —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ Qty + Unit
        if (qty && unit) {
          if (unit === "—É–ø–∞–∫" && !qtyPacks) qtyPacks = qty;
          if (unit !== "—É–ø–∞–∫" && !qtyUnits) qtyUnits = qty;
        }

        return { rowNo: get('rowNo'), title, article, qty, unit, qtyPacks, qtyUnits };
      }).filter(it => it.title || it.qty || it.qtyPacks || it.qtyUnits)
        .sort((a, b) => (parseInt(a.rowNo || 0, 10)) - (parseInt(b.rowNo || 0, 10)));
    }

    function updateTotals(){
      const items = collectItemsFromTable();
      const sumQty = items.reduce((s,it)=> s + (toNum(it.qty)||0), 0);
      const sumP = items.reduce((s,it)=> s + (toNum(it.qtyPacks)||0), 0);
      const sumU = items.reduce((s,it)=> s + (toNum(it.qtyUnits)||0), 0);
      const unitsSet = new Set(items.map(i=>i.unit).filter(Boolean));
      const unitsStr = unitsSet.size ? ` ‚Ä¢ –µ–¥: ${[...unitsSet].join(', ')}` : '';
      $('#totals').textContent = `–ò—Ç–æ–≥–æ: qty ${sumQty}${unitsStr} ‚Ä¢ —É–ø–∞–∫–æ–≤–æ–∫ ${sumP} ‚Ä¢ —à—Ç—É–∫ ${sumU}`;
      updateCreateDisabled();
    }

    function rerenderFromRaw() {
      const doMerge = $('#mergeToggle').checked;
      itemsRendered = doMerge ? mergeSameItemsKeepOrder(itemsParsedRaw) : [...itemsParsedRaw];
      renderItems(itemsRendered);
      const srcSet = new Set(itemsParsedRaw.map(x => x._src).filter(Boolean));
      $('#sourcesInfo').textContent = srcSet.size ? `–§–∞–π–ª—ã: ${Array.from(srcSet).join(', ')}` : '';
    }
    $('#mergeToggle').addEventListener('change', rerenderFromRaw);

    // ====== Firebase ======
    let _firebase=null, _app,_auth,_db;
    async function ensureFirebase() {
      if (_firebase) return _firebase;
      const appMod  = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js");
      const authMod = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js");
      const fsMod   = await import("https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js");
      _app = appMod.initializeApp(FIREBASE_CONFIG);
      _auth = authMod.getAuth(_app);
      _db   = fsMod.getFirestore(_app);
      try { await authMod.signInAnonymously(_auth); } catch(e){ console.warn("Anon auth failed:", e); }
      _firebase = { appMod, authMod, fsMod }; return _firebase;
    }

    // ====== Cloudinary ======
    async function uploadToCloudinary(file, taskId) {
      const form = new FormData();
      form.append('file', file);
      form.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
      form.append('folder', `tasks/${taskId}`);
      const resp = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`, { method:'POST', body: form });
      if (!resp.ok) throw new Error('Cloudinary upload failed: ' + resp.status);
      const j = await resp.json();
      return { url: j.secure_url, publicId: j.public_id, type: j.resource_type || 'raw', name: file.name || 'file' };
    }
    async function uploadAllToCloudinary(taskId) {
      const out = [];
      for (const f of filesAll) out.push(await uploadToCloudinary(f, taskId));
      return out;
    }

    // ====== Users (–∫–ª–∞–¥–æ–≤—â–∏–∫–∏) ======
    let usersAll = [];  // {id, name, role}
    let selectedWorkerIds = new Set();
    let selectedWorkerNames = new Set();
    function renderWorkers() {
      const box = $('#workersBox'); box.innerHTML = "";
      const workers = usersAll.filter(u => (u.role||"").toLowerCase() === "–∫–ª–∞–¥–æ–≤—â–∏–∫");
      (workers.length ? workers : usersAll).forEach(u => {
        const btn = document.createElement('button');
        btn.type = "button";
        btn.textContent = u.name || u.id;
        btn.className = "chip";
        let active = false;
        function setActive(a){ active = a; if (a) btn.classList.add('active'); else btn.classList.remove('active'); }
        btn.onclick = () => {
          if (!active) { selectedWorkerIds.add(u.id); selectedWorkerNames.add(u.name || u.id); }
          else         { selectedWorkerIds.delete(u.id); selectedWorkerNames.delete(u.name || u.id); }
          setActive(!active);
        };
        box.appendChild(btn);
      });
    }
    async function loadUsers() {
      try {
        const { fsMod } = await ensureFirebase();
        const snap = await fsMod.getDocs(fsMod.collection(_db, 'users'));
        usersAll = snap.docs.map(d => ({
          id: d.id,
          name: d.get('name') || d.get('displayName') || d.id,
          role: (d.get('role') || "").toString()
        }));
        renderWorkers();
      } catch (e) {
        console.error("loadUsers failed:", e);
        $('#workersBox').innerHTML = '<div class="muted">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
      }
    }

    // ====== –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á ======
    function getSelectedItems(){ return collectItemsFromTable(); }
    function updateCreateDisabled() {
      const okItems = getSelectedItems().length > 0;
      const okFiles = filesAll.length > 0;
      $('#btnCreate').disabled = !(okItems && okFiles);
    }
    async function createOneTaskFor(fsMod, title, comment, assigneeId, assigneeName, isPickup) {
      const docRef = fsMod.doc(fsMod.collection(_db, 'tasks'));
      const taskId = docRef.id;
      const data = {
        title, comment,
        assignees: assigneeId ? [assigneeId] : [],
        assigneeNames: assigneeName ? [assigneeName] : [],
        isPickup: !!isPickup,
        status: "assigned",
        createdAt: fsMod.serverTimestamp(),
        creatorId: "unknown",
        creatorName: "unknown",
        items: getSelectedItems(),
        source: "web-xlsx-autoheader",
        sourceMeta: { ua: navigator.userAgent, filesCount: filesAll.length },
        files: []
      };
      await fsMod.setDoc(docRef, data);
      const fileRecs = await uploadAllToCloudinary(taskId);
      await fsMod.updateDoc(docRef, { files: fileRecs });
      try {
        await fetch(VERCEL_NOTIFY_PROXY_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ taskId, assigneeIds: assigneeId ? [assigneeId] : [] })
        });
      } catch(e) { console.warn('notify failed', e); }
      return taskId;
    }
    async function createTask() {
      try {
        const title = $('#title').value.trim();
        const comment = $('#comment').value.trim();
        if (!title) { alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫'); return; }
        const items = getSelectedItems();
        if (!items.length) { alert('–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π'); return; }
        if (!filesAll.length) { alert('–î–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª(—ã)'); return; }
        $('#btnCreate').disabled = true;
        status('–°–æ–∑–¥–∞—é –∑–∞–¥–∞—á—É(–∏)‚Ä¶');

        const { fsMod } = await ensureFirebase();
        const workerIds = Array.from(selectedWorkerIds);
        const workerNames = Array.from(selectedWorkerNames);

        const createdIds = [];
        if (workerIds.length === 0) {
          const id = await createOneTaskFor(fsMod, title, comment, null, null, true);
          createdIds.push(id);
        } else {
          for (let i=0;i<workerIds.length;i++){
            const id = await createOneTaskFor(fsMod, title, comment, workerIds[i], workerNames[i] || workerIds[i], false);
            createdIds.push(id);
          }
        }

        status(`–ì–æ—Ç–æ–≤–æ. –°–æ–∑–¥–∞–Ω–æ –∑–∞–¥–∞—á: ${createdIds.length}`);
        alert(`–°–æ–∑–¥–∞–Ω–æ –∑–∞–¥–∞—á: ${createdIds.length}`);

        // —Å–±—Ä–æ—Å
        clearFiles();
        $('#itemsBody').innerHTML = "";
        $('#totals').textContent = "";
        $('#title').value = "";
        $('#comment').value = "";
        selectedWorkerIds.clear(); selectedWorkerNames.clear();
        updateCreateDisabled();
      } catch (e) {
        console.error(e);
        alert('–û—à–∏–±–∫–∞: ' + (e?.message||e));
        status('–û—à–∏–±–∫–∞');
        updateCreateDisabled();
      }
    }
    $('#btnCreate').addEventListener('click', createTask);

    // ====== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ======
    (async function init(){
      await ensureFirebase();
      await loadUsers();
      $('#mergeToggle').checked = false; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ù–ï –º–µ—Ä–¥–∂–∏–º ‚Äî –ø–æ—Ä—è–¥–æ–∫ –∫–∞–∫ –≤ –∏—Å—Ö–æ–¥–Ω–∏–∫–µ
      updateCreateDisabled();
    })();
  </script>
</body>
</html>


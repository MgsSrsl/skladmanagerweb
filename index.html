<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Создать задание — СкладСборка</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{ --brand-red:#FF3B30; --glass-fill:#fff; --text:#0d0d0d; --muted:#555; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#f5f6f8; color:var(--text) }
    .wrap{ max-width:720px; margin:0 auto; padding:24px 16px 120px }
    h1{ margin:6px 0 18px; font-size:28px; font-weight:800 }
    .card{ background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:16px; padding:16px }
    label{ font-weight:600; font-size:14px; display:block; margin:12px 0 6px }
    input[type="text"], textarea{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(0,0,0,.12); font:inherit; background:#fff
    }
    textarea{ min_HEIGHT:96px; resize:vertical }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .muted{ color:var(--muted); font-size:13px }
    .btn{ border:none; background:var(--brand-red); color:#fff; padding:14px 16px; border-radius:12px; font-weight:800; cursor:pointer }
    .btn:disabled{ opacity:.6; cursor:not-allowed }
    .btn-secondary{ background:#fff; color:var(--text); border:1px solid rgba(0,0,0,.12) }
    .files{ display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
    .chip{ display:inline-flex; gap:8px; align-items:center; background:#fff; border:1px solid rgba(0,0,0,.12); padding:8px 10px; border-radius:12px }
    .chip button{ border:none; background:transparent; font-weight:800; cursor:pointer }
    .footer{ position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid rgba(0,0,0,.08); padding:12px }
    .footer .inner{ max-width:720px; margin:0 auto; display:flex; gap:10px; justify-content:flex-end }
    .list{ height:180px; overflow:auto; border:1px solid rgba(0,0,0,.08); border-radius:12px; padding:8px }
    .updated{ position:fixed; right:14px; bottom:70px; font-size:13px; color:#222; opacity:.8 }
    .switch{ display:flex; align-items:center; gap:10px; margin-top:28px }
    .drop{ padding:12px; border:2px dashed rgba(0,0,0,.2); border-radius:12px; background:#fff }
    .drop.drag{ background:#f8fbff; border-color:#3d7bfd }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Создать задание</h1>

    <div class="card">
      <div class="row">
        <div>
          <label for="title">Название задания</label>
          <input id="title" type="text" placeholder="Например: Заказ 12345" />
        </div>
        <div class="switch">
          <input id="cbAssembled" type="checkbox" />
          <label for="cbAssembled" style="margin:0">Собранный заказ</label>
        </div>
      </div>

      <label for="comment">Комментарий</label>
      <textarea id="comment" placeholder="Опционально: примечания"></textarea>

      <div class="row">
        <div>
          <label>Файлы (PDF/изображения)</label>
          <div id="drop" class="drop">
            <input id="fileInput" type="file" multiple accept="image/*,application/pdf,.pdf" />
            <div class="muted">Выберите или перетащите файлы сюда</div>
          </div>
          <div id="files" class="files"></div>
          <div class="muted" id="filesInfo">Файлы не выбраны</div>
        </div>
        <div>
          <label>Кладовщики (мультивыбор)</label>
          <div id="users" class="list"></div>
          <div class="muted" id="assigneesInfo">Исполнители не выбраны (необязательно)</div>
        </div>
      </div>
    </div>

    <div class="updated" id="tvHomeLastUpdated">Список актуален: —</div>
  </div>

  <div class="footer">
    <div class="inner">
      <button id="btnClear" class="btn btn-secondary" type="button">Очистить файлы</button>
      <button id="btnSave" class="btn" type="button">Сохранить задание</button>
    </div>
  </div>

  <!-- Firebase только App/Auth/Firestore -->
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>

  <script>
  // ====== КОНФИГ ======
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyAH58ZpWAp64mhM589KD6jXHcOlPqU0aYU",
    authDomain: "skladsborka-6c2a7.firebaseapp.com",
    projectId: "skladsborka-6c2a7",
    storageBucket: "skladsborka-6c2a7.firebasestorage.app",
    appId: "1:516526717198:android:e470c17aed370572757f5f"
  };
  const CLOUDINARY_CLOUD_NAME    = "dnx1taqp7";
  const CLOUDINARY_UPLOAD_PRESET = "unsigned_tasks";
  const FOLDER_PREFIX            = "tasks";
  const NOTIFY_URL               = "https://skladsborka-notify.vercel.app/api/notify-taskCreated"; // оставил как у тебя
  // =====================

  firebase.initializeApp(FIREBASE_CONFIG);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  const els = {
    title: document.getElementById('title'),
    comment: document.getElementById('comment'),
    cbAssembled: document.getElementById('cbAssembled'),
    fileInput: document.getElementById('fileInput'),
    files: document.getElementById('files'),
    filesInfo: document.getElementById('filesInfo'),
    users: document.getElementById('users'),
    assigneesInfo: document.getElementById('assigneesInfo'),
    btnSave: document.getElementById('btnSave'),
    btnClear: document.getElementById('btnClear'),
    drop: document.getElementById('drop'),
    tvHomeLastUpdated: document.getElementById('tvHomeLastUpdated'),
  };

  const selectedFiles = [];
  const selectedWorkerIds = new Set();
  const selectedWorkerNames = new Set();
  let currentUser = null;

  auth.signInAnonymously()
    .then(c => { currentUser = c.user; touchLastUpdated(); return loadUsers(); })
    .catch(e => alert("Auth error: " + (e?.message||e)));

  async function loadUsers(){
    const snap = await db.collection('users').get();
    if (snap.empty){ els.users.innerHTML = '<div class="muted">Пользователи не найдены</div>'; return; }
    const frag = document.createDocumentFragment();
    snap.forEach(doc=>{
      const data = doc.data()||{};
      const role = (data.role||"")+""; const base = (data.name || data.displayName || doc.id);
      const label = role ? `${base} (${role})` : base; const id = doc.id;
      const row = document.createElement('label');
      row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.padding='6px 2px';
      row.innerHTML = `<input type="checkbox" data-id="${id}" data-name="${escapeHtml(label)}" /> <span>${escapeHtml(label)}</span>`;
      row.querySelector('input').addEventListener('change', ev=>{
        const chk = ev.target; const uid = chk.getAttribute('data-id'); const nm = chk.getAttribute('data-name');
        if (chk.checked){ selectedWorkerIds.add(uid); selectedWorkerNames.add(nm); }
        else { selectedWorkerIds.delete(uid); selectedWorkerNames.delete(nm); }
        updateAssigneesInfo();
      });
      frag.appendChild(row);
    });
    els.users.innerHTML = ''; els.users.appendChild(frag); updateAssigneesInfo();
  }

  function updateAssigneesInfo(){
    els.assigneesInfo.textContent = selectedWorkerNames.size
      ? "Исполнители: " + [...selectedWorkerNames].join(", ")
      : "Исполнители не выбраны (необязательно)";
  }

  els.fileInput.addEventListener('change', e=>{
    [...(e.target.files||[])].forEach(f=>{ if(!selectedFiles.includes(f)) selectedFiles.push(f); });
    renderFiles(); updateFilesInfo();
  });
  ['dragenter','dragover'].forEach(ev=> els.drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); els.drop.classList.add('drag'); }));
  ['dragleave','drop'].forEach(ev=> els.drop.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); els.drop.classList.remove('drag'); }));
  els.drop.addEventListener('drop', e=>{
    const files = [...(e.dataTransfer?.files||[])];
    files.forEach(f=>{ if(!selectedFiles.includes(f)) selectedFiles.push(f); });
    renderFiles(); updateFilesInfo();
  });
  els.btnClear.addEventListener('click', ()=>{ selectedFiles.length=0; renderFiles(); updateFilesInfo(); els.fileInput.value=''; });

  function renderFiles(){
    els.files.innerHTML = '';
    selectedFiles.forEach((f,i)=>{
      const chip=document.createElement('span');
      chip.className='chip';
      chip.innerHTML=`<span title="${escapeHtml(f.name)}">${escapeHtml(short(f.name))}</span> <button>&times;</button>`;
      chip.querySelector('button').onclick=()=>{selectedFiles.splice(i,1);renderFiles();updateFilesInfo();};
      els.files.appendChild(chip);
    });
  }
  function updateFilesInfo(){
    els.filesInfo.textContent = selectedFiles.length ? `Файлов выбрано: ${selectedFiles.length}` : 'Файлы не выбраны';
  }
  const short=s=>s.length>36?(s.slice(0,16)+'…'+s.slice(-16)):s;
  const escapeHtml=s=>s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));

  els.btnSave.addEventListener('click', onSave);
  async function onSave(){
    const title=els.title.value.trim(); const comment=els.comment.value.trim(); const isAssembled=!!els.cbAssembled.checked;
    if(!title){ alert("Введите название задания"); return; }
    freeze(true,"Сохраняю…");
    try{
      const audienceIds=[...selectedWorkerIds]; const audienceNames=[...selectedWorkerNames];
      const category=isAssembled?"assembled_order":(audienceIds.length===0?"pickup":"default");
      const status=isAssembled?"assembled":"assigned"; const isPickup=isAssembled?false:(audienceIds.length===0);
      const creatorId=(currentUser&&currentUser.uid)||"unknown"; const creatorName="web";

      const taskRef=db.collection('tasks').doc();
      await taskRef.set({
        title, comment,
        assignees:audienceIds, assigneeNames:audienceNames,
        isPickup, assembledOrder:isAssembled,
        category, status,
        createdAt:firebase.firestore.FieldValue.serverTimestamp(),
        creatorId, creatorName,
        files:[]
      });

      let uploaded=[];
      if(selectedFiles.length){
        uploaded=await uploadAllFiles(taskRef.id,selectedFiles);
        if(uploaded.length){ await taskRef.update({files:uploaded}); }
      }

      // уведомление — «в фоне», не блокируем UX
      notifyTaskCreated(taskRef.id,audienceIds).catch(()=>{});

      // очистка UI
      selectedFiles.length=0; renderFiles(); updateFilesInfo();
      els.title.value=''; els.comment.value=''; els.cbAssembled.checked=false;
      [...document.querySelectorAll('#users input[type=checkbox]')].forEach(ch=>ch.checked=false);
      selectedWorkerIds.clear(); selectedWorkerNames.clear(); updateAssigneesInfo();

      alert("Задание создано");
    }catch(e){ alert("Ошибка сохранения: "+(e?.message||e)); }
    finally{ freeze(false); touchLastUpdated(); }
  }

  // === ВАЖНО: строго как в приложении — всегда /auto/upload, без ручной замены на raw на этом этапе ===
  async function uploadAllFiles(taskId, files){
    const out=[];
    for(const f of files){
      const name = f.name || "file";
      const isPdf = /\.pdf$/i.test(name) || f.type === 'application/pdf';

      // ✅ Единая точка: auto/upload
      const endpoint = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/auto/upload`;

      const fd = new FormData();
      fd.append('file', f);
      fd.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
      fd.append('folder', `${FOLDER_PREFIX}/${taskId}`);

      const resp = await fetch(endpoint,{method:'POST',body:fd});
      if(!resp.ok){
        const t = await resp.text().catch(()=> "");
        throw new Error(`upload failed (${resp.status}) ${t}`);
      }
      const json = await resp.json();

      const url = json.secure_url || json.url || "";
      const pid = json.public_id || "";
      const rtype = (json.resource_type||"").toLowerCase();

      // тип в задаче помечаем для удобства рендера на мобилке
      const typeForTask = isPdf ? "pdf" : (rtype || "raw");

      out.push({ url, publicId: pid, type: typeForTask, name });
    }
    return out;
  }

  function notifyTaskCreated(taskId,audienceIds){
    const assigneeIdsCsv=(audienceIds&&audienceIds.length)?audienceIds.join(","):"";
    const body=new URLSearchParams({taskId,assigneeIds:assigneeIdsCsv});
    return fetch(NOTIFY_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body})
      .catch(()=>{});
  }

  function freeze(flag,text){ els.btnSave.disabled=!!flag; els.btnSave.textContent=flag?(text||"…"):"Сохранить задание"; }
  function touchLastUpdated(){
    const d=new Date(); const s=d.toLocaleDateString()+" "+d.toLocaleTimeString().slice(0,5);
    els.tvHomeLastUpdated.textContent="Список актуален: "+s;
  }
  </script>
</body>
</html>
